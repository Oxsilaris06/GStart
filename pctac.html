<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PC Tac</title>
    <link rel="icon" href="favicon.ico" sizes="any" type="image/png">
    <link rel="icon" href="favicon.ico" type="image/svg+xml">
    <link rel="apple-touch-icon" href="favicon.ico">
    
    <!-- Fonts mises à jour pour le thème Tactical -->
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Oswald:wght@300;400;500&family=Saira+Stencil+One&display=swap" rel="stylesheet">
    
    <!-- Utilisation des Material Symbols Outlined -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
    
    <!-- Librairies QR Code -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>

    <style>
        /* --- THEME TACTICAL GLASS (Importé de pctac tc) --- */
       :root {
            /* Palette Tactical */
            --bg-body: #050505;
            --bg-glass: rgba(22, 22, 25, 0.7);
            --bg-glass-heavy: rgba(15, 15, 20, 0.95);
            --bg-input: rgba(0, 0, 0, 0.4);
            --border-glass: rgba(255, 255, 255, 0.08);
            
            /* Typography */
            --font-ui: 'Oswald', sans-serif;
            --font-data: 'JetBrains Mono', monospace;
            --font-title: 'Saira Stencil One', cursive;

            /* Interactive Colors */
            --accent-blue: #3b82f6;
            --accent-glow: rgba(59, 130, 246, 0.3);
            --accent-hover: #2563eb;
            --text-main: #e0e0e0;
            --text-muted: #94a3b8;

            /* Status Colors */
            --danger-red: #ef4444; 
            --civil-yellow: #eab308;
            --inter-blue: #3b82f6;
            --ao-green: #22c55e;
            --trash-color: #64748b;
            
            /* Spacing */
            --radius-md: 12px;
            --radius-sm: 6px;

            /* Couleurs Mode Libre (Préservées de ADI) */
            --free-color-1: #800000;
            --free-color-2: #B87333;
            --free-color-3: #FFDB58;
            --free-color-4: #A3D900;
            --free-color-5: #00FFFF;
            --free-color-6: #000080;
            --free-color-7: #FF69B4;
            --free-color-8: #FF8C00;
            --free-color-9: #8A2BE2;
            --free-color-10: #008080;
            --free-color-11: #C0C0C0;
            --free-color-12: #ffffff;
        }

        body.light-mode {
            --bg-body: #f1f5f9;
            --bg-glass: rgba(255, 255, 255, 0.85);
            --bg-glass-heavy: #ffffff;
            --bg-input: rgba(255, 255, 255, 0.6);
            --border-glass: rgba(0, 0, 0, 0.1);
            --text-main: #1e293b;
            --text-muted: #64748b;
            --accent-blue: #0f4c9c;
        }

        /* --- RESET & GLOBAL LAYOUT --- */
        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; }
        
        body { 
            font-family: var(--font-ui); 
            background-color: var(--bg-body); 
            color: var(--text-main); 
            /* Texture tactique en fond */
            background-image: 
                linear-gradient(rgba(59, 130, 246, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(59, 130, 246, 0.03) 1px, transparent 1px);
            background-size: 40px 40px;
            min-height: 100vh;
            padding: 20px 10px 100px 10px;
            transition: background 0.3s ease;
            line-height: 1.6;
        }

        .container { 
            max-width: 1000px; 
            margin: 0 auto; 
            /* Suppression du fond opaque pour le style "Containerless/Glass" */
            background: transparent; 
            padding: 10px; 
            position: relative; 
        }

        h1 { 
            font-family: var(--font-title);
            font-size: 2.5em;
            color: var(--accent-blue);
            text-align: center;
            text-shadow: 0 0 20px var(--accent-glow);
            letter-spacing: 2px;
            margin-bottom: 25px;
            font-weight: 400;
        }
        
        /* --- FORMULAIRE STYLE GLASS --- */
        .log-entry-form {
            background: var(--bg-glass);
            backdrop-filter: blur(12px);
            border: 1px solid var(--border-glass);
            border-radius: var(--radius-md);
            padding: 20px;
            margin-bottom: 25px;
            position: relative;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .log-entry-form h3 {
            padding-right: 150px; 
            color: var(--text-muted);
            font-size: 1.1em;
            text-transform: uppercase;
            display: flex; 
            align-items: center; 
            gap: 8px;
        }
        
        .form-row {
            display: grid;
            gap: 15px;
        }
        
        /* Grille Responsive (Préservée de ADI) */
        @media (min-width: 768px) {
            .form-row.main-fields {
                grid-template-columns: 100px 1.2fr 1fr 1fr;
                align-items: end;
            }
            .form-row.text-fields {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 767px) {
            .form-row { grid-template-columns: 1fr; }
            .form-row.main-fields > div { margin-bottom: 5px; }
            .form-row.main-fields > div:nth-child(1) { order: 1; }
            .form-row.main-fields > div:nth-child(2) { order: 2; }
            .form-row.main-fields > div:nth-child(3) { order: 3; }
            .form-row.main-fields > div:nth-child(4) { order: 4; }
        }

        label { 
            color: var(--text-muted); 
            font-size: 0.75em; 
            text-transform: uppercase; 
            font-weight: bold; 
            margin-bottom: 5px; 
            display: block; 
        }

        /* INPUTS STYLE GLASS */
        input, textarea, select { 
            width: 100%; 
            background: var(--bg-input); 
            border: 1px solid var(--border-glass);
            border-radius: var(--radius-sm); 
            padding: 12px; 
            color: var(--text-main);
            font-family: var(--font-data); 
            font-size: 0.95em; 
            transition: all 0.2s;
            min-height: unset; /* Reset ADI height overrides */
        }
        
        input:focus, textarea:focus, select:focus {
            border-color: var(--accent-blue);
            background: rgba(0,0,0,0.5);
            box-shadow: 0 0 10px var(--accent-glow);
        }
        
        /* Input Time spécifique */
        #heure_input { 
            text-align: center; 
            color: var(--accent-blue); 
            font-weight: bold; 
        }
        
        /* --- TOGGLES & SELECTEURS --- */
        #pax_mode_toggle_container {
            position: absolute; 
            top: 20px; 
            right: 20px; 
            display: flex;
            background: rgba(0,0,0,0.2); 
            padding: 3px; 
            border-radius: 6px;
            gap: 0;
            z-index: 10;
        }
        
        .mode-toggle-btn {
            background: transparent; 
            border: none; 
            color: var(--text-muted);
            padding: 6px 12px; 
            border-radius: 4px; 
            cursor: pointer; 
            font-family: var(--font-ui); 
            font-weight: 500;
            transition: all 0.2s;
            font-size: 0.85em;
        }
        
        .mode-toggle-btn.active {
            background: var(--accent-blue); 
            color: white; 
            box-shadow: 0 2px 5px var(--accent-glow);
        }

        /* PAX SELECTORS */
        .pax-select { display: flex; gap: 8px; flex-wrap: wrap; }
        
        .pax-select-option {
            flex: 1; 
            padding: 12px 10px;
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--border-glass); 
            border-radius: var(--radius-sm);
            cursor: pointer; 
            text-align: center; 
            font-size: 0.9em; 
            font-weight: 500;
            transition: all 0.2s;
            min-width: 70px;
            color: var(--text-muted);
        }
        
        .pax-select-option:hover { background: rgba(255,255,255,0.1); }
        
        .pax-select-option.selected { 
            transform: scale(1.05); 
            border-color: transparent; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.3); 
            color: #fff;
            opacity: 1;
            font-weight: bold;
        }

        /* Couleurs Spécifiques PAX (Overrides pour le style selected) */
        .pax-select-option[data-pax="Adversaire"].selected { background: var(--danger-red); }
        .pax-select-option[data-pax="Otage"].selected, .pax-select-option[data-pax="Civil"].selected { background: var(--civil-yellow); color: black; }
        .pax-select-option[data-pax="Inter"].selected { background: var(--inter-blue); }
        .pax-select-option[data-pax="AO"].selected { background: var(--ao-green); color: black; }

        /* Free Mode Colors */
        #free_mode_options { 
            background: rgba(255,255,255,0.03); 
            padding: 10px; 
            border-radius: var(--radius-sm); 
            display: flex; flex-direction: column; gap: 10px;
        }
        .color-palette { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 5px; }
        .color-swatch { 
            width: 30px; height: 30px; 
            border-radius: 50%; 
            cursor: pointer; 
            border: 2px solid transparent; 
            transition: transform 0.2s; 
        }
        .color-swatch:hover { transform: scale(1.1); }
        .color-swatch.selected { border-color: white; transform: scale(1.2); }
        
        /* Mapping des couleurs libres */
        .swatch-1 { background-color: var(--free-color-1); }
        .swatch-2 { background-color: var(--free-color-2); }
        .swatch-3 { background-color: var(--free-color-3); }
        .swatch-4 { background-color: var(--free-color-4); }
        .swatch-5 { background-color: var(--free-color-5); }
        .swatch-6 { background-color: var(--free-color-6); }
        .swatch-7 { background-color: var(--free-color-7); }
        .swatch-8 { background-color: var(--free-color-8); }
        .swatch-9 { background-color: var(--free-color-9); }
        .swatch-10 { background-color: var(--free-color-10); }
        .swatch-11 { background-color: var(--free-color-11); border-color: #ffffff; }
        .swatch-12 { background-color: var(--free-color-12); border-color: #000000; }

        /* --- BUTTONS --- */
        .action-button {
            padding: 14px;
            border: none;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-family: var(--font-ui);
            font-size: 1.1em;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.2s;
            display: flex; align-items: center; justify-content: center; gap: 8px;
            box-shadow: 0 4px 12px var(--accent-glow);
        }
        .add-log-btn {
            background: var(--accent-blue);
            color: white;
            margin-top: 20px;
            width: 100%;
        }
        .add-log-btn:hover { filter: brightness(1.1); transform: translateY(-1px); }
        
        /* --- TABLEAU / LISTE STYLE GLASS --- */
        #logTableContainer {
            background: var(--bg-glass); 
            border: 1px solid var(--border-glass);
            border-radius: var(--radius-md); 
            overflow: hidden; 
            margin-top: 20px;
            overflow-x: auto;
        }
        #logTable {
            width: 100%;
            border-collapse: collapse;
            min-width: 600px;
        }
        #logTable th {
            text-align: left; 
            padding: 15px; 
            color: var(--text-muted); 
            font-size: 0.75em; 
            text-transform: uppercase; 
            background: rgba(0,0,0,0.2);
            border-bottom: 1px solid var(--border-glass);
            position: sticky; top: 0;
        }
        #logTable td {
            padding: 12px 15px; 
            border-bottom: 1px solid var(--border-glass); 
            vertical-align: middle;
            color: var(--text-main);
            font-size: 0.95em;
        }
        
        /* Styles spécifiques cellules */
        .heure-cell-text { 
            font-family: var(--font-data); 
            color: var(--accent-blue); 
            font-weight: bold; 
        }
        .pax-cell {
            padding: 4px 10px; 
            border-radius: 4px; 
            font-size: 0.85em; 
            font-weight: bold; 
            text-transform: uppercase;
            display: inline-block;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .delete-btn {
            background: none; border: none; 
            color: var(--trash-color); 
            cursor: pointer; 
            transition: color 0.2s; 
            opacity: 0.6;
        }
        .delete-btn:hover { color: var(--danger-red); opacity: 1; }
        
        .heure-action-cell { display: flex; align-items: center; justify-content: space-between; }

        /* Style pour l'élément déplacé */
        #logTable tbody tr.dragging {
            background: rgba(59, 130, 246, 0.1);
            border: 1px dashed var(--accent-blue);
        }
        
        /* --- DOCK MENU GLASS --- */
       .dock-menu { 
            position: fixed; 
            bottom: 20px; 
            left: 50%; 
            transform: translateX(-50%); 
            display: flex; 
            gap: 10px; 
            padding: 8px 15px; 
            z-index: 1000; 
            background: var(--bg-glass-heavy); 
            backdrop-filter: blur(15px);
            border: 1px solid var(--border-glass); 
            border-radius: 30px; 
            box-shadow: 0 10px 40px rgba(0,0,0,0.6);
            transition: width 0.3s, padding 0.3s;
            max-width: 90vw; width: auto; 
            overflow-x: auto; scrollbar-width: none;
        }
        .dock-menu::-webkit-scrollbar { display: none; }
        
        .dock-menu-item { 
            width: 42px; height: 42px; 
            border-radius: 50%; 
            flex-shrink: 0;
            display: flex; align-items: center; justify-content: center;
            background-color: transparent; 
            color: var(--text-muted); 
            border: none; 
            cursor: pointer; 
            transition: all 0.2s; 
            text-decoration: none;
            box-shadow: none;
        }
        .dock-menu-item:hover { color: var(--text-main); background: rgba(255,255,255,0.1); transform: scale(1.1); }
        
        .dock-menu.collapsed { 
            width: 50px; height: 50px; padding: 0; 
            justify-content: center; overflow: hidden; border-radius: 50%; 
        }
        .dock-menu.collapsed .dock-menu-item:not(#dockToggleBtn) { display: none; }
        
        #dockToggleBtn { color: var(--accent-blue); }
        #resetDataDockBtn span { color: var(--danger-red); }

        /* --- MODALES GLASS FIX --- */
        .custom-modal-backdrop { 
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.8); 
            backdrop-filter: blur(5px); 
            display: none; /* FIX: Caché par défaut */
            z-index: 2000;
        }
        
        .custom-modal {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: var(--bg-body); 
            border: 1px solid var(--border-glass); 
            border-radius: var(--radius-md);
            padding: 25px; 
            width: 95%; max-width: 450px; 
            z-index: 2001; 
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            display: none; /* FIX: Caché par défaut */
        }

        .modal-buttons { display: flex; gap: 10px; margin-top: 20px; }
        .modal-buttons button { 
            flex: 1; padding: 12px; 
            border: none; border-radius: var(--radius-sm); 
            cursor: pointer; font-weight: bold; font-family: var(--font-ui);
        }

        #confirmResetBtn, #confirmEditBtn { background: var(--accent-blue); color: white; }
        #confirmResetBtn { background: var(--danger-red); }
        #cancelResetBtn, #cancelEditBtn { background: rgba(255,255,255,0.1); color: var(--text-main); border: 1px solid var(--border-glass); }

        /* Footer */
		#main-footer { 
            width: 100%; text-align: center; margin-top: 30px; 
            font-size: 0.7rem; color: var(--text-muted); opacity: 0.5;
            border-top: none;
        }
        
        /* Styles spécifiques Transfert QR (Copie adaptée au theme) */
        .transfer-tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .transfer-tab-btn {
            flex: 1; padding: 10px; background: rgba(255,255,255,0.05); border: 1px solid var(--border-glass);
            color: var(--text-muted); cursor: pointer; border-radius: var(--radius-sm); font-family: var(--font-ui);
        }
        .transfer-tab-btn.active { background: var(--accent-blue); color: white; border-color: transparent; }
        
        .transfer-content { display: none; }
        .transfer-content.active { display: block; }
        
        /* CORRECTIF #1 : STYLE QR CODE FIX (Importé de pctac.html) */
        #qrcode-container {
            background: white; padding: 20px; border-radius: var(--radius-sm); margin: 20px auto;
            display: inline-block; 
            max-width: 100%; 
            min-height: 256px; /* Évite le saut de contenu */
        }
        #qrcode-container img, #qrcode-container canvas { 
            margin: 0 auto; 
            display: block; 
            max-width: 100% !important; 
            height: auto !important; 
        }
        
        #qr-reader {
            width: 100%; margin: 20px auto; border: 2px solid var(--accent-blue);
            border-radius: var(--radius-sm); overflow: hidden; background: black;
            height: 300px;
        }

        #qr-nav-controls {
            display: flex; justify-content: center; align-items: center; gap: 15px; margin-top: 15px;
            background: rgba(255,255,255,0.05); padding: 10px; border-radius: 8px;
        }
        .qr-nav-btn {
            background: rgba(255,255,255,0.1); border: 1px solid var(--border-glass); color: var(--text-main);
            width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer;
        }
        .qr-nav-btn:hover:not(:disabled) { background: var(--accent-blue); color: white; }
        #qr-counter { font-family: var(--font-data); font-weight: bold; font-size: 1.1em; min-width: 60px; text-align: center; }

        /* Ajustements Mobile */
        @media (max-width: 600px) {
             #pax_mode_toggle_container {
                position: static; 
                margin-bottom: 10px;
                background: transparent;
                padding: 0;
            }
            .log-entry-form h3 { padding-right: 0; }
            .mode-toggle-btn { flex: 1; border: 1px solid var(--border-glass); }
            .mode-toggle-btn.active { border-color: transparent; }
        }
    </style>
</head>
<body class="dark-mode">
    <!-- Champ de fichier caché pour l'importation de JSON -->
    <input type="file" id="jsonImportInput" accept=".json" style="display: none;">

    <!-- Modale de Confirmation Réinitialisation -->
    <div class="custom-modal-backdrop" id="modalBackdrop"></div>
    <div class="custom-modal" id="resetModal">
        <h3 style="color: var(--accent-blue); margin-bottom: 10px;">Confirmer la Réinitialisation</h3>
        <p style="color: var(--text-main);">Êtes-vous sûr de vouloir réinitialiser TOUTES les données de journalisation du PC Tac ? Cette action est irréversible et supprimera tout le tableau.</p>
        <div class="modal-buttons">
            <button id="confirmResetBtn">Oui, Réinitialiser</button>
            <button id="cancelResetBtn">Annuler</button>
        </div>
    </div>

    <!-- Modale d'Édition de Jalon -->
    <div class="custom-modal" id="editModal">
        <h3 style="color: var(--accent-blue); margin-bottom: 15px;">Modifier le Jalon</h3>
        <input type="hidden" id="edit_id">
        <div style="display: flex; flex-direction: column; gap: 10px;">
            <div>
                <label>Heure</label>
                <input type="time" id="edit_heure">
            </div>
            <div>
                <label>Pax</label>
                <!-- On simplifie l'édition par un select/input selon le mode original -->
                <div id="edit_pax_standard_container">
                    <select id="edit_pax_select">
                        <option value="Adversaire">Adversaire</option>
                        <option value="Otage">Civil/Otage</option>
                        <option value="Inter">Inter</option>
                        <option value="AO">AO</option>
                        <option value="Libre">Libre (TP)</option>
                    </select>
                </div>
                <div id="edit_pax_free_container" style="display:none; margin-top:5px;">
                    <input type="text" id="edit_free_pax_name" placeholder="Nom de l'intervenant">
                    <label style="margin-top:5px;">Couleur</label>
                    <div class="color-palette" id="edit_free_color_palette"></div>
                    <input type="hidden" id="edit_free_color_val">
                </div>
            </div>
            <div>
                <label>Lieu</label>
                <input type="text" id="edit_lieu">
            </div>
            <div>
                <label>Fenêtre/Porte</label>
                <input type="text" id="edit_fp">
            </div>
            <div>
                <label>Remarques</label>
                <textarea id="edit_remarques" rows="3"></textarea>
            </div>
        </div>
        <div class="modal-buttons">
            <button id="confirmEditBtn">Enregistrer</button>
            <button id="cancelEditBtn">Annuler</button>
        </div>
    </div>
    
    <!-- Modal Transfert (QR séquentiel local) -->
    <div class="custom-modal" id="transferModal">
        <h3 style="color: var(--accent-blue); margin-bottom: 15px;">Export/Import (QR Local)</h3>
        
        <div class="transfer-tabs">
            <button class="transfer-tab-btn active" data-tab="send">Exporter (QR Séquentiel)</button>
            <button class="transfer-tab-btn" data-tab="receive">Importer (Scan)</button>
        </div>
        
        <!-- Contenu Envoyer -->
        <div id="transfer-send" class="transfer-content active">
            <div id="qrcode-container"></div>
            
            <!-- Navigation QR Code -->
            <div id="qr-nav-controls" style="display: none;">
                <button class="qr-nav-btn" id="prevQrBtn"><span class="material-symbols-outlined">arrow_back</span></button>
                <span id="qr-counter">1/1</span>
                <button class="qr-nav-btn" id="nextQrBtn"><span class="material-symbols-outlined">arrow_forward</span></button>
            </div>
            
            <p id="qr-status-text" style="color: var(--text-muted); font-size: 0.85em; margin-top: 10px;"></p>
        </div>
        
        <!-- Contenu Recevoir -->
        <div id="transfer-receive" class="transfer-content">
            <div id="qr-reader"></div>
            <p style="color: var(--text-muted); font-size: 0.9em;">Scanner les QR codes séquentiellement pour importer.</p>
        </div>

        <div class="modal-buttons">
            <button id="closeTransferBtn" style="background: var(--accent-blue); color: white;">Terminer</button>
        </div>
    </div>
    
    <div class="container">
        <h1>PC Tac</h1>
        
        <!-- Formulaire d'ajout de ligne -->
        <form id="log-form" class="log-entry-form">
            <h3 style="margin-top: 0;"><span class="material-symbols-outlined">playlist_add</span> Ajouter une entrée</h3>
            
            <!-- NOUVEL EMPLACEMENT du toggle : Haut à droite du formulaire -->
            <div id="pax_mode_toggle_container">
                <button type="button" class="mode-toggle-btn active" data-mode="standard" onclick="setPaxMode('standard')">Forcené</button>
                <button type="button" class="mode-toggle-btn" data-mode="free" onclick="setPaxMode('free')">TP</button>
            </div>
            <!-- Fin NOUVEL EMPLACEMENT -->
            
            <!-- OPTIMISATION MOBILE: Le lieu et la fenêtre/porte sont déplacés à la fin de la grille pour une séquence Heure -> PAX -> Saisie rapide -->
            <div class="form-row main-fields">
                 <div>
                    <label for="heure_input">Heure</label>
                    <!-- Type="time" utilise l'interface de sélection d'heure native du mobile, très rapide -->
                    <input type="time" id="heure_input" required value="">
                 </div>
                 
                 <div>
                    <label>Pax</label>
                    
                    <!-- L'élément #pax_mode_toggle_container a été déplacé -->

                    <div id="pax_select_wrapper_standard" class="pax-select-wrapper">
                        <div class="pax-select" id="pax_select_container">
                            <span class="pax-select-option" data-pax="Adversaire">Adversaire</span>
                            <span class="pax-select-option" data-pax="Otage">Civil/Otage</span>
                            <span class="pax-select-option" data-pax="Inter">Inter</span>
                            <span class="pax-select-option" data-pax="AO">AO</span>
                        </div>
                    </div>
                    
                    <div id="pax_select_wrapper_free" class="pax-select-wrapper" style="display: none;">
                        <div id="free_mode_options">
                            <div class="color-palette" id="free_color_palette">
                                <!-- Les swatches de couleur sont générés par JS -->
                            </div>
                            <input type="text" id="free_pax_input" placeholder="Intervenant/Adversaire" value="" />
                            <input type="hidden" id="free_color_input" value="#800000" />
                        </div>
                    </div>
                    
                    <input type="hidden" id="pax_input" required value="Adversaire">
                    <input type="hidden" id="pax_mode_input" value="standard">
                    <input type="hidden" id="pax_custom_color_input" value="#800000">
                 </div>
                 
                 <div>
                    <label for="lieu_input">Lieu</label>
                    <input type="text" id="lieu_input" placeholder="Baptême terrain (A,B...)" value="">
                 </div>

                 <div>
                    <label for="fenetre_porte_input">Fenêtre/Porte</label>
                    <input type="text" id="fenetre_porte_input" placeholder="Ex: B1,A102" value="">
                 </div>
                 
            </div>
            
            <div class="form-row text-fields">
                <div style="grid-column: span 1;">
                    <label for="remarques_input">Remarques</label>
                    <!-- OPTIMISATION: Mise en évidence du champ remarques -->
                    <textarea id="remarques_input" rows="3" placeholder="Informations clés, compte-rendu..."></textarea>
                </div>
            </div>

            <button type="submit" class="action-button add-log-btn" id="addLogBtn">
                <span class="material-symbols-outlined">add_task</span> Ajouter au Log
            </button>
        </form>

        <!-- Tableau des entrées -->
        <div id="logTableContainer">
            <table id="logTable">
                <thead>
                    <tr>
                        <th style="width: 15%;">Heure</th>
                        <th style="width: 15%;">Pax</th>
                        <th style="width: 20%;">Lieu</th>
                        <th style="width: 20%;">Fenêtre/Porte</th>
                        <th style="width: 30%;">Remarques</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Les lignes de log seront insérées ici -->
                </tbody>
            </table>
        </div>
        
		<footer id="main-footer">
            © PC Tac by G/ Maheux
        </footer>
    </div>
    
    <!-- Dock Flottant -->
    <div class="dock-menu collapsed" id="dockMenu">
        <!-- Bouton de bascule du dock -->
        <button class="dock-menu-item" id="dockToggleBtn" title="Ouvrir/Réduire">
            <span class="material-symbols-outlined">expand_less</span>
        </button>
        <!-- Bouton Alt Route (Remplace Home) -->
        <a class="dock-menu-item" href="1.html" title="Générateur d'OI" style="text-decoration: none;">
            <span class="material-symbols-outlined">alt_route</span>
        </a>
        
        <!-- NOUVEAU BOUTON : Transfert QR Local -->
        <div class="dock-menu-item" id="transferDockBtn" title="Transfert QR Local"><span class="material-symbols-outlined">qr_code_2</span></div>
        
        <!-- Bouton Export JSON -->
        <div class="dock-menu-item" id="exportJsonDockBtn" title="Exporter les données au format JSON">
            <span class="material-symbols-outlined">save</span>
        </div>
         <!-- Bouton Import JSON -->
         <div class="dock-menu-item" id="importJsonDockBtn" title="Importer des données au format JSON">
            <span class="material-symbols-outlined">upload_file</span>
        </div>
        
        <div class="dock-menu-item" id="darkModeToggle" title="Changer le thème">
            <span class="material-symbols-outlined" id="darkModeIcon">nightlight</span>
        </div>
        <div class="dock-menu-item" id="fullscreenToggle" title="Plein écran">
            <span class="material-symbols-outlined" id="fullscreenIcon">fullscreen</span>
        </div>
        <!-- Bouton PDF (téléchargement direct) -->
         <div class="dock-menu-item" id="previewPdfDockBtn" title="Générer et télécharger le PDF">
            <span class="material-symbols-outlined">picture_as_pdf</span>
        </div>
        <!-- Bouton Réinitialisation -->
         <div class="dock-menu-item" id="resetDataDockBtn" title="Réinitialiser toutes les données">
            <span class="material-symbols-outlined" style="color: var(--danger-red);">delete_forever</span>
        </div>
    </div>

    <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
    <script>
        const LOCAL_STORAGE_KEY = 'pcTacLogData';
        
        // --- COULEURS ÉTENDUES ---
        const FREE_MODE_COLORS = [
            { hex: '#800000', name: 'Bordeaux' },       
            { hex: '#B87333', name: 'Cuivre' },         
            { hex: '#FFDB58', name: 'Jaune Moutarde' }, 
            { hex: '#A3D900', name: 'Vert Lime' },      
            { hex: '#00FFFF', name: 'Cyan' },           
            { hex: '#000080', name: 'Bleu Marine' },    
            { hex: '#FF69B4', name: 'Rose Vif' },       
            { hex: '#FF8C00', name: 'Orange Foncée' },  
            { hex: '#8A2BE2', name: 'Bleu Violet' },    
            { hex: '#008080', name: 'Sarcelle' },       
            { hex: '#C0C0C0', name: 'Argent' },         
            { hex: '#ffffff', name: 'Blanc' }           
        ];

        // Couleurs statiques pour le PDF (Standard)
        const PDF_PAX_COLORS = {
            'Adversaire': { text: 'Adversaire', color: '#be1b09', fontColor: '#ffffff' },
            'Otage': { text: 'Civil/Otage', color: '#f1c40f', fontColor: '#000000' }, 
            'Civil': { text: 'Civil/Otage', color: '#f1c40f', fontColor: '#000000' }, 
            'Inter': { text: 'Inter', color: '#3498db', fontColor: '#ffffff' },
            'AO': { text: 'AO', color: '#2ecc71', fontColor: '#000000' }
        };

        const logTableBody = document.querySelector('#logTable tbody');
        const logForm = document.getElementById('log-form');
        const heureInput = document.getElementById('heure_input');
        const paxInput = document.getElementById('pax_input');
        const paxModeInput = document.getElementById('pax_mode_input'); 
        const paxCustomColorInput = document.getElementById('pax_custom_color_input'); 
        const freePaxInput = document.getElementById('free_pax_input'); 
        const lieuInput = document.getElementById('lieu_input');
        const fenetrePorteInput = document.getElementById('fenetre_porte_input');
        const remarquesInput = document.getElementById('remarques_input');
        const paxSelectContainer = document.getElementById('pax_select_container');
        const freeColorPalette = document.getElementById('free_color_palette'); 
        const previewPdfDockBtn = document.getElementById('previewPdfDockBtn');
        const resetDataDockBtn = document.getElementById('resetDataDockBtn');
        const jsonImportInput = document.getElementById('jsonImportInput'); 
        const exportJsonDockBtn = document.getElementById('exportJsonDockBtn'); 
        const importJsonDockBtn = document.getElementById('importJsonDockBtn'); 
        
        // --- Nouveaux éléments Transfert QR local (déplacés de pctac) ---
        const transferDockBtn = document.getElementById('transferDockBtn');
        const transferModal = document.getElementById('transferModal');
        const closeTransferBtn = document.getElementById('closeTransferBtn');
        const transferTabs = document.querySelectorAll('.transfer-tab-btn');
        let html5QrCodeLocal; 
        let qrChunks = [];
        let currentQrIndex = 0;
        
        // OPTIMISATION QR: Version 14-20
        // Réduction du batch pour s'assurer que les données tiennent dans une version 15
        const QR_BATCH_SIZE = 5; 
        
        // Variable pour suivre si l'utilisateur a modifié l'heure manuellement
        let isTimeInputManuallyChanged = false;

        // --- GESTION APPUI LONG POUR MODIF ---
        let longPressTimer;
        const LONG_PRESS_DELAY = 700;

        function handleLongPressStart(e, id) {
            longPressTimer = setTimeout(() => {
                openEditModal(id);
            }, LONG_PRESS_DELAY);
        }

        function handleLongPressEnd() {
            clearTimeout(longPressTimer);
        }

        // --- 1. Gestion des Données et Stockage ---

        function saveLogData(logData) {
            try {
                // Tri par heure avant de sauvegarder (maintient l'ordre pour l'ajout standard)
                logData.sort((a, b) => {
                    if (a.heure === b.heure) return 0;
                    if (a.heure < b.heure) return -1;
                    if (a.heure > b.heure) return 1;
                    return 0; 
                });
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(logData));
            } catch (e) {
                console.error("Erreur de sauvegarde des données:", e);
            }
        }

        function loadLogData() {
            try {
                const dataString = localStorage.getItem(LOCAL_STORAGE_KEY);
                return dataString ? JSON.parse(dataString) : [];
            } catch (e) {
                console.error("Erreur de chargement des données:", e);
                return [];
            }
        }
        
        function getLogData() {
            // Récupère l'ordre actuel du DOM (important pour le Drag & Drop)
            return Array.from(logTableBody.querySelectorAll('tr')).map(row => {
                const getSafeDataset = (key) => {
                    const value = row.dataset[key] || '';
                    return value === 'undefined' ? '' : value; 
                };
                
                const paxMode = getSafeDataset('paxmode') || 'standard';
                let paxValue = getSafeDataset('pax');

                if (paxMode === 'free') {
                    paxValue = getSafeDataset('freepaxname') || 'Pax Libre';
                }

                return {
                    id: row.dataset.id,
                    heure: row.querySelector('.heure-cell-text').textContent,
                    pax: paxValue,
                    paxMode: paxMode, 
                    paxColor: getSafeDataset('paxcolor') || (paxMode === 'free' ? FREE_MODE_COLORS[0].hex : undefined), 
                    lieu: getSafeDataset('lieu'),
                    fenetrePorte: getSafeDataset('fenetreporte'),
                    remarques: getSafeDataset('remarques'),
                };
            });
        }
        
        function renderLogTable(logData) {
            // Tri par heure pour le rendu initial et après une réinitialisation
            logData.sort((a, b) => {
                if (a.heure < b.heure) return -1;
                if (a.heure > b.heure) return 1;
                return 0; 
            });

            logTableBody.innerHTML = '';
            
            logData.forEach(entry => {
                
                let paxColor, paxText, paxFontColor;

                if (entry.paxMode === 'standard') {
                    const paxInfo = PDF_PAX_COLORS[entry.pax] || PDF_PAX_COLORS['Adversaire'];
                    paxColor = paxInfo.color;
                    paxText = paxInfo.text;
                    paxFontColor = paxInfo.fontColor;
                } else {
                    paxColor = entry.paxColor || FREE_MODE_COLORS[0].hex;
                    paxText = entry.pax;
                    const r = parseInt(paxColor.slice(1, 3), 16);
                    const g = parseInt(paxColor.slice(3, 5), 16);
                    const b = parseInt(paxColor.slice(5, 7), 16);
                    const luminosity = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
                    paxFontColor = luminosity > 0.5 ? '#000000' : '#ffffff';
                }

                const row = logTableBody.insertRow();
                row.dataset.id = entry.id;
                row.dataset.lieu = entry.lieu || '';
                row.dataset.fenetreporte = entry.fenetrePorte || '';
                row.dataset.remarques = entry.remarques || '';
                row.dataset.pax = entry.paxMode === 'standard' ? entry.pax : 'Libre'; 
                row.dataset.freepaxname = entry.paxMode === 'free' ? entry.pax : ''; 
                row.dataset.paxmode = entry.paxMode; 
                row.dataset.paxcolor = entry.paxMode === 'free' ? paxColor : ''; 
                
                // Rendre la ligne déplaçable
                row.draggable = true;
                row.classList.add('draggable-row');
                row.addEventListener('dragstart', handleDragStart);

                // GESTION APPUI LONG (Touch & Mouse)
                row.addEventListener('mousedown', (e) => handleLongPressStart(e, entry.id));
                row.addEventListener('touchstart', (e) => handleLongPressStart(e, entry.id), {passive: true});
                row.addEventListener('mouseup', handleLongPressEnd);
                row.addEventListener('mouseleave', handleLongPressEnd);
                row.addEventListener('touchend', handleLongPressEnd);
                row.addEventListener('touchmove', handleLongPressEnd, {passive: true});

                const heureCell = row.insertCell();
                heureCell.style.width = '15%';
                heureCell.innerHTML = `
                    <div class="heure-action-cell">
                        <span class="heure-cell-text">${entry.heure}</span>
                        <button type="button" class="delete-btn" onclick="deleteLogEntry('${entry.id}')">
                            <span class="material-symbols-outlined">close</span>
                        </button>
                    </div>`;

                const paxCell = row.insertCell();
                paxCell.style.width = '15%';
                paxCell.innerHTML = `<span class="pax-cell" style="background-color: ${paxColor}; color: ${paxFontColor};">${paxText}</span>`;
                
                const lieuCell = row.insertCell();
                lieuCell.style.width = '20%';
                lieuCell.textContent = entry.lieu;

                const fpCell = row.insertCell();
                fpCell.style.width = '20%';
                fpCell.textContent = entry.fenetrePorte;

                const remarquesCell = row.insertCell();
                remarquesCell.style.width = '30%'; 
                remarquesCell.textContent = entry.remarques;
            });
            
             // Mettre à jour les données dans localStorage après le rendu trié
             saveLogData(getLogData());
        }
        
        function addLogEntry(e) {
            e.preventDefault();

            const mode = paxModeInput.value;
            let paxName, paxColorHex;

            if (mode === 'standard') {
                paxName = paxInput.value;
                paxColorHex = ''; 
                if (!paxName) {
                    alert("Veuillez sélectionner un type de PAX standard.");
                    return;
                }
            } else {
                paxName = freePaxInput.value.trim() || 'Pax Libre';
                paxColorHex = paxCustomColorInput.value;
                if (!freePaxInput.value.trim()) {
                     alert("Veuillez donner un nom a l'intervenant.");
                     return;
                }
            }

            if (!heureInput.value) {
                alert("Veuillez renseigner l'heure.");
                return;
            }
            
            const currentHeure = heureInput.value;

            const newEntry = {
                id: Date.now().toString(36) + Math.random().toString(36).substr(2, 5),
                heure: currentHeure,
                pax: paxName, 
                paxMode: mode,
                paxColor: paxColorHex,
                lieu: lieuInput.value.trim(),
                fenetrePorte: fenetrePorteInput.value.trim(),
                remarques: remarquesInput.value.trim(),
            };

            const logData = loadLogData();
            logData.push(newEntry);
            isTimeInputManuallyChanged = false;
            renderLogTable(logData);

            updateTimeInput(); 
            lieuInput.value = '';
            fenetrePorteInput.value = '';
            remarquesInput.value = '';
            remarquesInput.focus();
        }
        
        function deleteLogEntry(id) {
            const logData = getLogData().filter(entry => entry.id !== id);
            renderLogTable(logData);
        }

        // --- 2. Logique de sélection Pax (Standard et Libre) ---
        
        function getHexToRgb(hex) {
             const bigint = parseInt(hex.slice(1), 16);
             const r = (bigint >> 16) & 255;
             const g = (bigint >> 8) & 255;
             const b = bigint & 255;
             return { r: r / 255, g: r / 255, b: b / 255 }; 
        }
        
        function selectColorSwatch(hexColor, containerId = 'free_color_palette', inputId = 'pax_custom_color_input') {
             const container = document.getElementById(containerId);
             const input = document.getElementById(inputId);
             const allSwatches = Array.from(container.querySelectorAll('.color-swatch'));
             allSwatches.forEach(s => s.classList.remove('selected'));
             
             const targetSwatch = allSwatches.find(s => s.dataset.color.toLowerCase() === hexColor.toLowerCase());
             
             if (targetSwatch) {
                 targetSwatch.classList.add('selected');
                 input.value = hexColor;
                 return true;
             }
             return false;
        }


        function initPaxModeAndColors() {
            const paletteContainer = document.getElementById('free_color_palette');
            const editPaletteContainer = document.getElementById('edit_free_color_palette');
            
            [paletteContainer, editPaletteContainer].forEach(container => {
                container.innerHTML = '';
                FREE_MODE_COLORS.forEach((color, index) => {
                    const swatch = document.createElement('span');
                    swatch.className = `color-swatch swatch-${index + 1}`;
                    swatch.dataset.color = color.hex;
                    swatch.style.backgroundColor = color.hex;
                    if (color.hex === '#ffffff') swatch.style.borderColor = '#000000';

                    swatch.addEventListener('click', function() {
                        const isEdit = container.id.includes('edit');
                        selectColorSwatch(this.dataset.color, container.id, isEdit ? 'edit_free_color_val' : 'pax_custom_color_input');
                    });
                    container.appendChild(swatch);
                });
            });
            
            selectColorSwatch(FREE_MODE_COLORS[0].hex);
            setPaxMode('standard');

            Array.from(paxSelectContainer.querySelectorAll('.pax-select-option')).forEach(option => {
                option.addEventListener('click', function() {
                    Array.from(paxSelectContainer.querySelectorAll('.pax-select-option')).forEach(o => o.classList.remove('selected'));
                    this.classList.add('selected');
                    paxInput.value = this.dataset.pax;
                    lieuInput.focus();
                });
            });

            paxInput.value = 'Adversaire';
            const initialOption = paxSelectContainer.querySelector(`[data-pax="Adversaire"]`);
            if (initialOption) initialOption.classList.add('selected');
        }
        
        function setPaxMode(mode) {
            const isStandard = mode === 'standard';
            document.getElementById('pax_select_wrapper_standard').style.display = isStandard ? 'block' : 'none';
            document.getElementById('pax_select_wrapper_free').style.display = isStandard ? 'none' : 'block';
            
            document.querySelectorAll('#pax_mode_toggle_container .mode-toggle-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.mode === mode);
            });

            paxModeInput.value = mode;

            if (isStandard) {
                 const selectedOption = paxSelectContainer.querySelector('.pax-select-option.selected');
                 paxInput.value = selectedOption ? selectedOption.dataset.pax : 'Adversaire';
            } else {
                 paxInput.value = freePaxInput.value.trim() || 'Pax Libre';
                 freePaxInput.focus();
            }
        }

        // --- EDITION DE JALON ---
        function openEditModal(id) {
            const logData = loadLogData();
            const entry = logData.find(e => e.id === id);
            if (!entry) return;

            document.getElementById('edit_id').value = id;
            document.getElementById('edit_heure').value = entry.heure;
            document.getElementById('edit_lieu').value = entry.lieu || '';
            document.getElementById('edit_fp').value = entry.fenetrePorte || '';
            document.getElementById('edit_remarques').value = entry.remarques || '';
            
            const paxSelect = document.getElementById('edit_pax_select');
            const freeContainer = document.getElementById('edit_pax_free_container');
            const freeNameInput = document.getElementById('edit_free_pax_name');

            if (entry.paxMode === 'standard') {
                paxSelect.value = entry.pax;
                freeContainer.style.display = 'none';
            } else {
                paxSelect.value = 'Libre';
                freeContainer.style.display = 'block';
                freeNameInput.value = entry.pax;
                selectColorSwatch(entry.paxColor || FREE_MODE_COLORS[0].hex, 'edit_free_color_palette', 'edit_free_color_val');
            }

            document.getElementById('modalBackdrop').style.display = 'block';
            document.getElementById('editModal').style.display = 'block';
        }

        document.getElementById('edit_pax_select').addEventListener('change', (e) => {
            const isFree = e.target.value === 'Libre';
            document.getElementById('edit_pax_free_container').style.display = isFree ? 'block' : 'none';
            if (isFree) selectColorSwatch(FREE_MODE_COLORS[0].hex, 'edit_free_color_palette', 'edit_free_color_val');
        });

        document.getElementById('confirmEditBtn').addEventListener('click', () => {
            const id = document.getElementById('edit_id').value;
            const logData = loadLogData();
            const index = logData.findIndex(e => e.id === id);
            if (index === -1) return;

            const paxSelectVal = document.getElementById('edit_pax_select').value;
            let paxName, mode, color;

            if (paxSelectVal === 'Libre') {
                mode = 'free';
                paxName = document.getElementById('edit_free_pax_name').value.trim() || 'Pax Libre';
                color = document.getElementById('edit_free_color_val').value;
            } else {
                mode = 'standard';
                paxName = paxSelectVal;
                color = '';
            }

            logData[index] = {
                ...logData[index],
                heure: document.getElementById('edit_heure').value,
                pax: paxName,
                paxMode: mode,
                paxColor: color,
                lieu: document.getElementById('edit_lieu').value.trim(),
                fenetrePorte: document.getElementById('edit_fp').value.trim(),
                remarques: document.getElementById('edit_remarques').value.trim()
            };

            renderLogTable(logData);
            hideEditModal();
        });

        function hideEditModal() {
            document.getElementById('modalBackdrop').style.display = 'none';
            document.getElementById('editModal').style.display = 'none';
        }

        document.getElementById('cancelEditBtn').addEventListener('click', hideEditModal);

        // --- Mise à jour de l'heure en temps réel ---

        function updateTimeInput() {
            if (!isTimeInputManuallyChanged) {
                const now = new Date();
                const hours = String(now.getHours()).padStart(2, '0');
                const minutes = String(now.getMinutes()).padStart(2, '0');
                heureInput.value = `${hours}:${minutes}`;
            }
        }

        // Détecter la modification manuelle
        heureInput.addEventListener('change', () => {
            isTimeInputManuallyChanged = true;
        });
        
        // --- 3. Logique Drag & Drop ---
        
        let dragSrcEl = null;

        function handleDragStart(e) {
            dragSrcEl = this;
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', this.dataset.id);
            this.classList.add('dragging');
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            const targetRow = this;

            if (targetRow.closest('tbody') !== logTableBody) return; 
            if (dragSrcEl === targetRow) return;

            const rect = targetRow.getBoundingClientRect();
            const offsetY = e.clientY - rect.top;
            const halfHeight = rect.height / 2;

            if (offsetY < halfHeight) {
                logTableBody.insertBefore(dragSrcEl, targetRow);
            } else {
                logTableBody.insertBefore(dragSrcEl, targetRow.nextSibling);
            }
        }

        function handleDrop(e) {
            e.stopPropagation();
            e.preventDefault(); 
            saveLogData(getLogData()); 
            renderLogTable(loadLogData());
            return false;
        }

        function handleDragEnd(e) {
            this.classList.remove('dragging');
        }
        
        // --- 4. Gestion JSON (Export/Import) ---
        
        function exportJson() {
             const logData = getLogData();
             if (logData.length === 0) {
                 alert("Le journal est vide. Rien à exporter.");
                 return;
             }
             
             const now = new Date();
             const datePart = now.toISOString().split('T')[0];
             const timePart = now.toTimeString().split(' ')[0].replace(/:/g, '-'); 
             const fileName = `PC_Tac_Session_${datePart}_${timePart}.json`;

             const exportObject = {
                 metadata: { appName: "PC Tac Log", version: "1.0", timestamp: now.toISOString() },
                 logEntries: logData
             };

             const jsonString = JSON.stringify(exportObject, null, 2);
             const blob = new Blob([jsonString], { type: "application/json" });
             const url = URL.createObjectURL(blob);
             const link = document.createElement('a');
             link.href = url;
             link.download = fileName;
             document.body.appendChild(link);
             link.click();
             document.body.removeChild(link);
             URL.revokeObjectURL(url);
        }
        
        async function importJson(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const jsonContent = JSON.parse(e.target.result);
                    if (jsonContent.metadata && jsonContent.metadata.appName === "PC Tac Log" && Array.isArray(jsonContent.logEntries)) {
                        const validatedEntries = jsonContent.logEntries.map(entry => ({
                            id: entry.id || Date.now().toString(36) + Math.random().toString(36).substr(2, 5),
                            heure: entry.heure || '00:00',
                            pax: entry.pax,
                            paxMode: entry.paxMode || (PDF_PAX_COLORS[entry.pax] ? 'standard' : 'free'),
                            paxColor: entry.paxColor || (entry.paxMode === 'free' ? FREE_MODE_COLORS[0].hex : undefined),
                            lieu: entry.lieu || '',
                            fenetrePorte: entry.fenetrePorte || '',
                            remarques: entry.remarques || '',
                        }));
                        const mergedLogs = [...loadLogData(), ...validatedEntries];
                        renderLogTable(mergedLogs);
                        alert(`Importation réussie : ${validatedEntries.length} entrées ajoutées.`);
                    } else {
                        throw new Error("Fichier JSON invalide.");
                    }
                } catch (error) {
                    alert(`Erreur d'importation : ${error.message}`);
                } finally {
                    jsonImportInput.value = ''; 
                    initPaxModeAndColors();
                }
            };
            reader.readAsText(file);
        }
        
        // --- 5. Génération PDF ---
        
        function wrapTextForPdf(font, fontSize, text, maxWidth) {
            text = String(text || ''); 
            const chunks = text.replace(/\r?\n/g, ' \n ').split(' ');
            let lines = []; 
            let currentLine = '';

            for (const chunk of chunks) {
                if (chunk === '\n') { 
                    lines.push(currentLine.trim()); 
                    currentLine = ''; 
                    continue; 
                }
                const lineWithChunk = currentLine === '' ? chunk : `${currentLine} ${chunk}`;
                if (font.widthOfTextAtSize(lineWithChunk, fontSize) > maxWidth && currentLine !== '') { 
                    lines.push(currentLine.trim()); 
                    currentLine = chunk; 
                } else { 
                    currentLine = lineWithChunk; 
                }
            }
            lines.push(currentLine.trim()); 
            return lines.filter(line => line.length > 0);
        }
        
        function getPdfColors(isDarkMode, rgb) {
            return isDarkMode ? { background: rgb(0, 0, 0), text: rgb(1, 1, 1), line: rgb(1, 1, 1) } : { background: rgb(1, 1, 1), text: rgb(0, 0, 0), line: rgb(0, 0, 0) };
        }

        let pdfRgb; 

        async function buildPdf() {
            if (typeof PDFLib === 'undefined') return null;
            const { PDFDocument, StandardFonts, rgb, PageSizes } = PDFLib;
            pdfRgb = rgb; 
            const pdfDoc = await PDFDocument.create();
            const helveticaFont = await pdfDoc.embedFont(StandardFonts.Helvetica);
            const helveticaBoldFont = await pdfDoc.embedFont(StandardFonts.HelveticaBold);
            const logData = getLogData();
            const pdfThemeColors = getPdfColors(document.body.classList.contains('dark-mode'), rgb); 
            
            const pageConfig = { width: PageSizes.A4[1], height: PageSizes.A4[0], margin: 30, fontSize: 10, lineHeight: 14 };
            const colWidths = [0.05, 0.10, 0.15, 0.15, 0.55]; 
            
            const context = {
                pdfDoc, helveticaFont, helveticaBoldFont, currentPage: null, y: 0, pageNumber: 0,
                pageWidth: pageConfig.width, pageHeight: pageConfig.height, margin: pageConfig.margin,
                fontSize: pageConfig.fontSize, lineHeight: pageConfig.lineHeight, colors: { ...pdfThemeColors }
            };
            
            const drawFooter = () => {
                const footerText = `Page ${context.pageNumber}`;
                context.currentPage.drawText(footerText, {
                    x: (context.pageWidth / 2) - (context.helveticaFont.widthOfTextAtSize(footerText, context.fontSize) / 2), 
                    y: context.margin / 2, font: context.helveticaFont, size: context.fontSize, color: context.colors.text
                });
            };

            const addNewPage = () => {
                if (context.currentPage) drawFooter();
                context.currentPage = context.pdfDoc.addPage([PageSizes.A4[1], PageSizes.A4[0]]); 
                context.pageNumber++;
                context.pageWidth = context.currentPage.getWidth();
                context.pageHeight = context.currentPage.getHeight();
                context.y = context.pageHeight - context.margin;
                context.currentPage.drawRectangle({ x: 0, y: 0, width: context.pageWidth, height: context.pageHeight, color: context.colors.background });
                context.currentPage.drawText("PC TAC - Journal d'intervention", {
                    x: context.margin, y: context.pageHeight - context.margin / 2, font: context.helveticaBoldFont, size: 14, color: context.colors.text
                });
                context.y -= 40; 
            };

            const checkY = (spaceNeeded) => { 
                if (context.y - spaceNeeded < context.margin * 1.5) { addNewPage(); drawTableHeader(); return true; } 
                return false; 
            };
            
            const drawTableHeader = () => {
                 const headers = ["Heure", "Pax", "Lieu", "Fenêtre/Porte", "Remarques"];
                 let currentX = context.margin;
                 const tableY = context.y;
                 context.currentPage.drawLine({ start: { x: context.margin, y: tableY - 1 }, end: { x: context.pageWidth - context.margin, y: tableY - 1 }, color: context.colors.line, thickness: 1 });
                 headers.forEach((header, i) => {
                     context.currentPage.drawText(header, { x: currentX + 2, y: tableY - context.lineHeight + 5, font: context.helveticaBoldFont, size: context.fontSize, color: context.colors.text });
                     currentX += context.pageWidth * colWidths[i];
                 });
                 context.y -= (context.lineHeight + 5);
            };

            const drawLogEntry = (entry) => {
                let paxColorHex, paxText, paxTextColor;
                if (entry.paxMode === 'standard') {
                    const paxInfo = PDF_PAX_COLORS[entry.pax] || PDF_PAX_COLORS['Adversaire'];
                    paxColorHex = paxInfo.color;
                    paxText = paxInfo.text;
                    paxTextColor = paxInfo.fontColor === '#000000' ? pdfRgb(0, 0, 0) : pdfRgb(1, 1, 1);
                } else {
                    paxColorHex = entry.paxColor || FREE_MODE_COLORS[0].hex;
                    paxText = entry.pax;
                    const r = parseInt(paxColorHex.slice(1, 3), 16) / 255;
                    const g = parseInt(paxColorHex.slice(3, 5), 16) / 255;
                    const b = parseInt(paxColorHex.slice(5, 7), 16) / 255; 
                    paxTextColor = (0.299 * r + 0.587 * g + 0.114 * b) > 0.5 ? pdfRgb(0, 0, 0) : pdfRgb(1, 1, 1);
                }
                const paxPdfColor = pdfRgb(parseInt(paxColorHex.slice(1, 3), 16) / 255, parseInt(paxColorHex.slice(3, 5), 16) / 255, parseInt(paxColorHex.slice(5, 7), 16) / 255); 
                const colWidthsPx = colWidths.map(ratio => context.pageWidth * ratio - 4);
                const allLines = [entry.heure, paxText, entry.lieu, entry.fenetrePorte, entry.remarques].map((text, i) => wrapTextForPdf(i === 1 ? context.helveticaBoldFont : context.helveticaFont, context.fontSize, text, colWidthsPx[i]));
                const rowHeight = Math.max(...allLines.map(l => l.length)) * context.lineHeight + 5;
                if (checkY(rowHeight)) return;

                let currentX = context.margin;
                const tableY = context.y;
                allLines.forEach((textLines, i) => {
                    const colWidth = context.pageWidth * colWidths[i];
                    if (i === 1) {
                        const bgX = currentX + 1;
                        const pY = tableY - rowHeight + (rowHeight - context.lineHeight - 4) / 2;
                        context.currentPage.drawRectangle({ x: bgX, y: pY, width: colWidthsPx[i] - 2, height: context.lineHeight + 4, color: paxPdfColor });
                        context.currentPage.drawText(textLines[0] || '', { x: bgX + (colWidthsPx[i] - context.helveticaBoldFont.widthOfTextAtSize(textLines[0] || '', context.fontSize)) / 2, y: pY + (context.lineHeight + 4 - context.fontSize) / 2 + 1, font: context.helveticaBoldFont, size: context.fontSize, color: paxTextColor });
                    } else {
                        textLines.forEach((line, lineIndex) => { context.currentPage.drawText(line, { x: currentX + 2, y: tableY - context.lineHeight - (lineIndex * context.lineHeight) - 2, font: context.helveticaFont, size: context.fontSize, color: context.colors.text }); });
                    }
                    currentX += colWidth;
                });
                context.currentPage.drawLine({ start: { x: context.margin, y: tableY - rowHeight + 1 }, end: { x: context.pageWidth - context.margin, y: tableY - rowHeight + 1 }, color: context.colors.line, thickness: 0.5, opacity: 0.5 });
                context.y -= rowHeight;
            };

            addNewPage(); drawTableHeader();
            logData.forEach(entry => drawLogEntry(entry));
            drawFooter();
            return await pdfDoc.save();
        }

        async function downloadPdf() {
            const btn = previewPdfDockBtn; 
            btn.querySelector('.material-symbols-outlined').textContent = 'sync';
            btn.disabled = true;
            try {
                const pdfBytes = await buildPdf();
                if (!pdfBytes) return;
                const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                const fileName = `PC_Tac_Log_${new Date().toLocaleDateString('fr-FR').replace(/\//g, '-')}.pdf`;
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url; link.download = fileName;
                document.body.appendChild(link); link.click();
                setTimeout(() => { document.body.removeChild(link); URL.revokeObjectURL(url); }, 0); 
            } catch (error) { alert("Erreur lors de la génération."); }
            finally { btn.querySelector('.material-symbols-outlined').textContent = 'picture_as_pdf'; btn.disabled = false; }
        }
        
        // --- 6. Logique du Dock et Divers ---

        function isFullscreen() { return document.fullscreenElement || document.webkitFullscreenElement || document.mozFullScreenElement || document.msFullscreenElement; }

        function toggleFullscreen() {
            if (!isFullscreen()) {
                if (document.documentElement.requestFullscreen) document.documentElement.requestFullscreen();
            } else {
                if (document.exitFullscreen) document.exitFullscreen();
            }
        }
        
        function updateFullscreenIcon() {
            const icon = document.getElementById('fullscreenIcon');
            if (icon) icon.textContent = isFullscreen() ? 'fullscreen_exit' : 'fullscreen';
        }

        function handleThemeToggle() {
            document.body.classList.toggle('light-mode'); 
            document.body.classList.toggle('dark-mode');
            const isDarkMode = document.body.classList.contains('dark-mode');
            localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
            document.getElementById('darkModeIcon').textContent = isDarkMode ? 'nightlight' : 'clear_day';
        }

        function toggleDock() {
            const dock = document.getElementById('dockMenu');
            const dockCollapsed = dock.classList.toggle('collapsed');
            localStorage.setItem('dockCollapsed', dockCollapsed);
            const icon = document.querySelector('#dockToggleBtn .material-symbols-outlined');
            if (icon) icon.textContent = dockCollapsed ? 'expand_less' : 'expand_more';
        }
        
        function showResetModal() {
            document.getElementById('modalBackdrop').style.display = 'block';
            document.getElementById('resetModal').style.display = 'block';
        }

        function hideResetModal() {
            document.getElementById('modalBackdrop').style.display = 'none';
            document.getElementById('resetModal').style.display = 'none';
            hideEditModal();
        }

        function handleResetData() {
            localStorage.removeItem(LOCAL_STORAGE_KEY);
            renderLogTable([]);
            hideResetModal();
            updateTimeInput();
            setPaxMode('standard');
            lieuInput.value = ''; fenetrePorteInput.value = ''; remarquesInput.value = '';
            alert("Journal réinitialisé.");
        }
        
        // --- 7. LOGIQUE TRANSFERT QR SÉQUENTIEL (CORRECTIF APPLIQUÉ) ---

        function chunkArray(array, size) {
            const chunks = [];
            for (let i = 0; i < array.length; i += size) chunks.push(array.slice(i, i + size));
            return chunks;
        }

        function openTransferModal() {
            document.getElementById('modalBackdrop').style.display = 'block';
            transferModal.style.display = 'block';
            switchTransferTab('send');
        }
        
        function closeTransferModal() {
            document.getElementById('modalBackdrop').style.display = 'none';
            transferModal.style.display = 'none';
            // Stop scanner if active
            if(html5QrCodeLocal) { 
                html5QrCodeLocal.stop().catch(err => console.log("Stop failed", err));
                html5QrCodeLocal = null; 
            }
        }
        
        function switchTransferTab(tabName) {
            transferTabs.forEach(t => t.classList.toggle('active', t.dataset.tab === tabName));
            document.querySelectorAll('.transfer-content').forEach(c => c.classList.remove('active'));
            document.getElementById(`transfer-${tabName}`).classList.add('active');
            
            if(tabName === 'send') {
                // If we were scanning, stop it
                if(html5QrCodeLocal) { 
                    html5QrCodeLocal.stop().then(() => html5QrCodeLocal = null).catch(err => console.error(err));
                }
                prepareQRPagination(); 
            } else {
                startScanner();
            }
        }
        
        function prepareQRPagination() {
            const logs = getLogData();
            const container = document.getElementById('qrcode-container');
            const statusText = document.getElementById('qr-status-text');
            const navControls = document.getElementById('qr-nav-controls');
            
            container.innerHTML = '';
            
            if (logs.length === 0) {
                container.textContent = "Aucune donnée à transférer.";
                if(statusText) statusText.textContent = "";
                if(navControls) navControls.style.display = 'none';
                return;
            }

            // Compression des données (Array of arrays) pour gagner de la place dans le QR
            let compressedData = logs.map(l => [l.id, l.heure, l.pax, l.paxMode, l.paxColor, l.lieu, l.fenetrePorte, l.remarques]);
            
            qrChunks = chunkArray(compressedData, QR_BATCH_SIZE);
            currentQrIndex = 0;
            
            if(navControls) {
                navControls.style.display = qrChunks.length > 1 ? 'flex' : 'none';
            }
            
            // CORRECTIF #1 suite : Utiliser un délai pour laisser le modal s'afficher avant de dessiner
            setTimeout(() => {
                showQR(currentQrIndex);
            }, 50);
        }

        function showQR(index) {
            const container = document.getElementById('qrcode-container');
            const statusText = document.getElementById('qr-status-text');
            const counter = document.getElementById('qr-counter');
            const prevBtn = document.getElementById('prevQrBtn');
            const nextBtn = document.getElementById('nextQrBtn');
            
            container.innerHTML = '';
            
            // Structure compatible avec pctac.html : t = titre, d = data
            // v1 n'a pas d'input titre, on envoie une chaine vide ou par défaut
            let transferPayload = { t: "PC-TAC-V1", d: qrChunks[index] };
            let jsonString = JSON.stringify(transferPayload);
            
            new QRCode(container, {
                text: jsonString,
                width: 256,
                height: 256,
                colorDark : "#000000",
                colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.L,
                // OPTIMISATION: Version fixe pour la stabilité
                typeNumber: 15
            });
            
            if (qrChunks.length > 1) {
                if(statusText) statusText.textContent = `Page ${index + 1} sur ${qrChunks.length} - ${qrChunks[index].length} entrées.`;
                if(counter) counter.textContent = `${index + 1} / ${qrChunks.length}`;
                if(prevBtn) prevBtn.disabled = index === 0;
                if(nextBtn) nextBtn.disabled = index === qrChunks.length - 1;
            } else {
                if(statusText) statusText.textContent = `${qrChunks[0].length} entrées prêtes au transfert.`;
            }
        }

        function startScanner() {
            if (html5QrCodeLocal) return; 
            html5QrCodeLocal = new Html5Qrcode("qr-reader");
            // OPTIMISATION: FPS augmenté pour une lecture plus rapide
            const config = { fps: 20, qrbox: { width: 250, height: 250 } };
            html5QrCodeLocal.start({ facingMode: "environment" }, config, onScanSuccess)
            .catch(err => {
                document.getElementById('qr-reader').textContent = "Erreur caméra: " + err;
            });
        }

        function onScanSuccess(decodedText) {
            try {
                const data = JSON.parse(decodedText);
                // Compatible avec les formats {d: [...]} (v1 ancien) et {t:..., d:[...]} (v2 nouveau)
                if (data.d && Array.isArray(data.d)) {
                    const currentLogs = getLogData();
                    const currentIds = new Set(currentLogs.map(l => l.id));
                    let added = 0;
                    data.d.forEach(item => { 
                        if (!currentIds.has(item[0])) { 
                            currentLogs.push({ id: item[0], heure: item[1], pax: item[2], paxMode: item[3], paxColor: item[4], lieu: item[5], fenetrePorte: item[6], remarques: item[7] }); 
                            added++; 
                        } 
                    });
                    if (added > 0) { renderLogTable(currentLogs); alert(`${added} entrées ajoutées.`); }
                }
            } catch (e) {
                console.error(e);
            }
        }
        
        // --- 8. Initialisation ---

        document.addEventListener('DOMContentLoaded', () => {
            if (localStorage.getItem('theme') === 'light') document.body.classList.replace('dark-mode', 'light-mode');
            document.getElementById('darkModeIcon').textContent = document.body.classList.contains('dark-mode') ? 'nightlight' : 'clear_day';
            document.getElementById('fullscreenToggle').addEventListener('click', toggleFullscreen);
            document.getElementById('darkModeToggle').addEventListener('click', handleThemeToggle);
            document.getElementById('dockToggleBtn').addEventListener('click', toggleDock);
            document.addEventListener('fullscreenchange', updateFullscreenIcon);
            updateFullscreenIcon(); 
            updateTimeInput();
            setInterval(updateTimeInput, 60000);
            logForm.addEventListener('submit', addLogEntry);
            initPaxModeAndColors();
            logTableBody.addEventListener('dragover', handleDragOver);
            logTableBody.addEventListener('drop', handleDrop);
            logTableBody.addEventListener('dragend', handleDragEnd); 
            renderLogTable(loadLogData());
            document.getElementById('free_pax_input').addEventListener('input', (e) => { if (paxModeInput.value === 'free') paxInput.value = e.target.value.trim() || 'Pax Libre'; });
            previewPdfDockBtn.addEventListener('click', downloadPdf);
            exportJsonDockBtn.addEventListener('click', exportJson);
            importJsonDockBtn.addEventListener('click', () => jsonImportInput.click());
            jsonImportInput.addEventListener('change', importJson);
            resetDataDockBtn.addEventListener('click', showResetModal);
            document.getElementById('confirmResetBtn').addEventListener('click', handleResetData);
            document.getElementById('cancelResetBtn').addEventListener('click', hideResetModal);
            
            // Listeners Transfert QR
            transferDockBtn.addEventListener('click', openTransferModal);
            closeTransferBtn.addEventListener('click', closeTransferModal);
            transferTabs.forEach(btn => btn.addEventListener('click', (e) => switchTransferTab(e.target.dataset.tab)));
            
            document.getElementById('prevQrBtn').addEventListener('click', () => { 
                if (currentQrIndex > 0) { currentQrIndex--; showQR(currentQrIndex); }
            });
            document.getElementById('nextQrBtn').addEventListener('click', () => { 
                if (currentQrIndex < qrChunks.length - 1) { currentQrIndex++; showQR(currentQrIndex); }
            });
            
            document.getElementById('modalBackdrop').addEventListener('click', (e) => {
                if (e.target.id === 'modalBackdrop') {
                    hideResetModal();
                    closeTransferModal();
                }
            });
        });
        
        window.setPaxMode = setPaxMode;
        window.deleteLogEntry = deleteLogEntry;
    </script>
</body>
</html>
