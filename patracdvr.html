<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PATRACDVR</title>
    <link rel="manifest" href="manifest.json">
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;500&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Saira+Stencil+One&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
    <link rel="icon" href="favicon.ico" sizes="any" type="image/png">
    <link rel="icon" href="favicon.ico" type="image/svg+xml">
    <link rel="apple-touch-icon" href="favicon.ico">
    <style>
        /* --- VARIABLES & THEME TACTICAL GLASS --- */
        :root {
            --bg-body: #050505;
            --bg-glass: rgba(22, 22, 25, 0.7);
            --bg-glass-heavy: rgba(15, 15, 20, 0.95);
            --bg-input: rgba(0, 0, 0, 0.4);
            --bg-element: rgba(255, 255, 255, 0.03);
            --border-glass: rgba(255, 255, 255, 0.08);
            
            --font-ui: 'Oswald', sans-serif;
            --font-title: 'Saira Stencil One', cursive;

            --accent-blue: #3b82f6;
            --accent-hover: #2563eb;
            --accent-glow: rgba(59, 130, 246, 0.3);
            --text-primary: #e0e0e0;
            --text-secondary: #94a3b8;
            
            --danger-red: #ef4444;
            --success-green: #22c55e;
            --trash-color: #6c757d;

            --radius-md: 12px;
            --radius-sm: 6px;
        }

        /* --- LAYOUT GLOBAL --- */
        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: var(--font-ui);
            background-color: var(--bg-body);
            color: var(--text-primary);
            background-image: 
                linear-gradient(rgba(59, 130, 246, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(59, 130, 246, 0.03) 1px, transparent 1px);
            background-size: 40px 40px;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            width: 100%; max-width: 1200px; margin: auto;
            background: var(--bg-glass);
            backdrop-filter: blur(12px);
            border: 1px solid var(--border-glass);
            border-radius: var(--radius-md);
            padding: 25px;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.2);
            padding-bottom: 80px;
        }

        h1 {
            font-family: var(--font-title);
            font-size: 2.2em;
            color: var(--accent-blue);
            text-align: center;
            text-shadow: 0 0 20px var(--accent-glow);
            letter-spacing: 2px;
            margin-bottom: 25px;
        }

        h4 {
            font-size: 1.1em;
            color: var(--text-secondary);
            margin-top: 15px;
            margin-bottom: 8px;
            font-weight: normal;
            border-bottom: 1px solid var(--border-glass);
            padding-bottom: 5px;
        }

        /* --- BOUTONS --- */
        button {
            font-family: var(--font-ui);
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }

        button.add-btn {
            background-color: var(--bg-element);
            color: var(--text-primary);
            border: 1px solid var(--border-glass);
            border-radius: 4px;
            padding: 8px 12px;
            min-height: 44px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        button.add-btn:hover {
            background-color: rgba(255,255,255,0.1);
            border-color: var(--accent-blue);
        }

        button.remove-btn {
            background-color: transparent;
            color: var(--danger-red);
            padding: 5px;
            font-size: 1.2em;
        }

        .action-bar {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
            padding: 10px;
            border: 1px dashed var(--border-glass);
            border-radius: 5px;
            justify-content: space-between;
            background: rgba(0,0,0,0.2);
        }

        #generatePdfBtn {
            background-color: var(--accent-blue);
            color: white;
            width: 100%;
            margin-top: 20px;
            padding: 15px;
            font-size: 1.2em;
            font-weight: bold;
            box-shadow: 0 0 15px var(--accent-glow);
        }
        #generatePdfBtn:hover { background-color: var(--accent-hover); }

        /* --- PATRACDVR & DRAG-DROP --- */
        #patracdvr_container, #unassigned_members_container { 
            display: flex; flex-wrap: wrap; gap: 10px; padding: 15px; min-height: 70px; 
            border: 1px dashed var(--border-glass); border-radius: var(--radius-sm); align-content: flex-start;
            background: rgba(0,0,0,0.2); margin-top: 10px; transition: border-color 0.2s;
        }
        
        .draggable { cursor: grab; user-select: none; }
        .draggable.dragging { opacity: 0.5; cursor: grabbing; border: 1px dashed var(--accent-blue); }

        /* Lignes Véhicules */
        .patracdvr-vehicle-row {
            background: rgba(255,255,255,0.03); border: 1px solid var(--border-glass);
            border-radius: var(--radius-sm); padding: 10px; padding-top: 40px; 
            margin-bottom: 10px; position: relative;
            display: flex; flex-direction: column; min-width: 160px; width: auto; flex-grow: 1;
            align-items: flex-start; justify-content: flex-start; gap: 8px;
        }
        .vehicle-header {
            position: absolute; top: 0; left: 0; right: 0; 
            background: rgba(255,255,255,0.05); padding: 5px 10px;
            border-bottom: 1px solid var(--border-glass);
            display: flex; justify-content: space-between; align-items: center;
        }
        .vehicle-name { color: var(--accent-blue); font-weight: bold; font-family: var(--font-ui); font-size: 0.9em; text-transform: uppercase; }
        
        .patracdvr-members-container {
            min-height: 60px; width: 100%; display: flex; flex-wrap: wrap; gap: 8px;
            border: 1px dashed var(--border-glass); border-radius: 4px; padding: 5px;
            align-content: flex-start;
        }

        /* Boutons Membres */
        .patracdvr-member-btn { 
            background: var(--bg-glass-heavy); border: 1px solid var(--border-glass); 
            color: var(--text-primary); padding: 8px; border-radius: 4px; 
            min-height: 56px; min-width: 90px; transition: all 0.2s;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            cursor: grab; position: relative;
        }
        .patracdvr-member-btn:hover { border-color: var(--accent-blue); transform: translateY(-2px); }
        .patracdvr-member-btn.member-active { 
            border-color: var(--accent-blue); box-shadow: 0 0 10px var(--accent-glow); color: white; background: var(--accent-blue);
        }
        .patracdvr-member-btn .trigramme { font-weight: bold; font-family: var(--font-title); letter-spacing: 1px; font-size: 1.2em; }
        .patracdvr-member-btn .fonction { font-size: 0.75em; color: var(--text-secondary); display: block; margin-top: 2px; }
        .patracdvr-member-btn.member-active .fonction { color: rgba(255,255,255,0.9); }

        /* Corbeille */
        #trashCan {
            margin-top: 20px; padding: 20px;
            border: 3px dashed var(--trash-color); border-radius: 10px;
            text-align: center; color: var(--trash-color); background: rgba(0,0,0,0.2);
            transition: all 0.3s; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100px; font-weight: bold;
        }
        #trashCan.drag-over { border-color: var(--danger-red); background: rgba(239, 68, 68, 0.1); color: var(--danger-red); }
        #trashCan .material-symbols-outlined { font-size: 40px; margin-bottom: 5px; }

        /* --- QUICK EDIT PANEL --- */
        #quickEditPanel {
            background: var(--bg-element); border: 1px solid var(--border-glass);
            padding: 15px; border-radius: var(--radius-sm); margin-bottom: 20px;
            display: none; flex-direction: column;
            animation: fadeIn 0.3s ease-out;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        #quickEditPanel .member-info-header { 
            display: flex; align-items: center; gap: 20px; margin-bottom: 15px; 
            padding-bottom: 10px; border-bottom: 1px solid var(--border-glass); 
            flex-wrap: wrap;
        }

        .quick-edit-content { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        
        .quick-edit-category { margin-bottom: 10px; }
        .quick-edit-category h5 { 
            border-bottom: 1px solid var(--border-glass); padding-bottom: 5px; margin-bottom: 8px; 
            color: var(--text-secondary); font-size: 0.9em; text-transform: uppercase; 
        }
        .quick-edit-options { display: flex; flex-wrap: wrap; gap: 6px; }
        
        .quick-edit-btn {
            background: var(--bg-input); border: 1px solid var(--border-glass);
            color: var(--text-secondary); padding: 4px 8px; border-radius: 4px; 
            font-size: 0.85em; font-family: var(--font-ui);
        }
        .quick-edit-btn:hover { border-color: var(--accent-blue); color: var(--text-primary); }
        .quick-edit-btn.selected { 
            background: var(--accent-blue); color: white; border-color: transparent; 
            box-shadow: 0 0 5px var(--accent-glow);
        }

        input[type="text"], input[type="time"] {
            background: var(--bg-input); border: 1px solid var(--border-glass);
            border-radius: 4px; padding: 8px; color: white; font-family: var(--font-ui);
        }
        input[type="text"]:focus, input[type="time"]:focus { border-color: var(--accent-blue); }

        /* Mission Inputs Area */
        .mission-inputs {
            display: flex; gap: 15px; flex-wrap: wrap;
            margin-bottom: 20px; padding: 15px;
            background: var(--bg-element); border: 1px solid var(--border-glass);
            border-radius: 5px;
        }
        .mission-input-group { flex-grow: 1; min-width: 200px; }
        .mission-input-group label { display: block; color: var(--text-secondary); font-size: 0.8em; margin-bottom: 5px; text-transform: uppercase; }
        .mission-input-group input { width: 100%; }


        /* --- DIALOG / MODAL --- */
        dialog {
            background: var(--bg-glass-heavy); color: var(--text-primary);
            border: 1px solid var(--border-glass); border-radius: var(--radius-md);
            padding: 20px; backdrop-filter: blur(20px);
            box-shadow: 0 20px 50px rgba(0,0,0,0.8); margin: auto;
            max-width: 500px; width: 90%;
        }
        dialog::backdrop { background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); }
        dialog h3 { color: var(--accent-blue); border-bottom: 1px solid var(--border-glass); padding-bottom: 10px; margin-bottom: 15px; text-transform: uppercase; font-family: var(--font-title); }
        .modal-form { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .modal-form .full-width { grid-column: 1 / -1; }
        .modal-form label { font-size: 0.85em; color: var(--text-secondary); margin-bottom: 4px; display: block; text-transform: uppercase; }
        .modal-form select, .modal-form input { 
            width: 100%; background: var(--bg-input); 
            border: 1px solid var(--border-glass); border-radius: 4px; 
            padding: 10px; color: white; font-family: var(--font-ui);
        }
        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; border-top: 1px solid var(--border-glass); padding-top: 15px; }


        /* Configuration Buttons */
        #vehicle_creation_buttons { 
            display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; 
            padding: 10px; border: 1px dashed var(--border-glass); 
            border-radius: 5px; 
        }

        /* Footer */
        footer {
            margin-top: 40px; text-align: center; color: var(--text-secondary);
            font-size: 0.8em; border-top: 1px solid var(--border-glass); padding-top: 10px;
        }

        @media (max-width: 767px) {
            .container { padding: 10px; }
            h1 { font-size: 1.8em; }
            .patracdvr-vehicle-row { min-width: 100%; }
            .quick-edit-content { grid-template-columns: 1fr; }
            .modal-form { grid-template-columns: 1fr; }
        }

        /* --- CONFIGURATION COLLAPSIBLE (MERGED FROM paramOI) --- */
        .collapsible { 
            background-color: var(--bg-element); 
            border: 1px solid var(--border-glass); 
            border-radius: var(--radius-sm); 
            margin-top: 20px;
            margin-bottom: 15px; 
            overflow: hidden; 
            transition: border-color 0.3s;
        }
        .collapsible-header { 
            cursor: pointer; padding: 15px; 
            display: flex; justify-content: space-between; align-items: center; 
            background: rgba(255,255,255,0.02);
        }
        .collapsible-header h4 { 
            border: none; padding: 0; margin: 0; 
            color: var(--accent-blue);
            font-family: var(--font-ui);
            font-weight: bold;
        }
        .collapsible-header .toggle-arrow { font-size: 1.2em; transition: transform 0.3s; color: var(--text-secondary); }
        .collapsible-content { padding: 0 15px; max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out, padding 0.3s ease-out; }
        .collapsible.open { border-color: var(--accent-blue); }
        .collapsible.open .collapsible-header .toggle-arrow { transform: rotate(180deg); color: var(--accent-blue); }
        .collapsible.open .collapsible-content { max-height: 5000px; padding-bottom: 15px; padding-top: 15px; }

        .form-group { margin-bottom: 15px; }
        .form-group textarea {
            width: 100%; padding: 12px; 
            border: 1px solid var(--border-glass); border-radius: var(--radius-sm);
            font-size: 0.9rem; background-color: var(--bg-input); 
            color: var(--text-primary); font-family: var(--font-ui);
            transition: all 0.2s;
            min-height: 80px; resize: vertical;
        }
        .form-group textarea:focus {
            border-color: var(--accent-blue);
            box-shadow: 0 0 10px var(--accent-glow);
        }
        .form-group .help-text { font-size: 0.8em; color: var(--text-secondary); margin-top: 5px; font-style: italic; }
    </style>
</head>
<body>

    <div class="container">
        <h1>PATRACDVR </h1>

        <!-- ACTION BAR -->
        <div class="action-bar">
            <!-- Modification: Groupement des boutons de gauche -->
            <div style="display:flex; gap:10px;">
                <button type="button" id="resetBtn" class="add-btn remove-btn" title="Tout Effacer" style="color: var(--trash-color); border: 1px solid var(--trash-color);">
                    <span class="material-symbols-outlined">delete_forever</span> RAZ
                </button>
                <button type="button" onclick="window.location.href='1.html'" class="add-btn" title="Retour à l'Ordre Initial" style="color: var(--text-secondary); border: 1px solid var(--text-secondary);">
                    <span class="material-symbols-outlined">arrow_back</span> Retour a l'OI
                </button>
            </div>
            
            <div style="display:flex; gap:10px; flex-wrap: wrap;">
                <button type="button" id="importSessionBtn" class="add-btn" title="Importer une sauvegarde JSON">
                    <span class="material-symbols-outlined">upload_file</span> Importer Sauvegarde
                </button>
                <input type="file" id="importFileInput" accept=".json" style="display: none;">
                <button type="button" id="exportSessionBtn" class="add-btn" title="Sauvegarder Session">
                    <span class="material-symbols-outlined">save</span>
                </button>
            </div>
        </div>

        <!-- MISSION INFO AREA -->
        <div class="mission-inputs">
            <div class="mission-input-group">
                <label for="missionTitleInput">Titre de la mission</label>
                <input type="text" id="missionTitleInput" placeholder=" Ex:  OP JUD X ">
            </div>
            <div class="mission-input-group">
                <label for="rallyTimeInput">Heure de rassemblement</label>
                <input type="text" id="rallyTimeInput" placeholder=" Ex: 06:00 " >
            </div>
        </div>

        <!-- QUICK EDIT PANEL -->
        <div id="quickEditPanel">
            <div class="member-info-header">
                <h4 style="margin: 0; border:none; color: var(--accent-blue);">Édition : <span id="selectedMemberTrigramme" style="font-weight: bold;">Aucun</span></h4>
                <div style="flex-grow: 1;">
                    <input type="text" id="quick_edit_trigramme_input" placeholder="Trigramme" style="max-width: 150px;">
                </div>
                <button type="button" id="closeQuickEdit" class="remove-btn"><span class="material-symbols-outlined">close</span></button>
            </div>
            <div class="quick-edit-content"></div>
        </div>

        <!-- CREATION ZONES -->
        <h4>1. Gestion des Véhicules</h4>
        <div id="vehicle_creation_buttons">
            <button type="button" class="add-btn" id="addManualVehicleBtn" style="border-color: var(--accent-blue); color: var(--accent-blue);">➕ Créer Véhicule</button>
            <!-- Les boutons de véhicules prédéfinis seront injectés ici -->
        </div>

        <h4>2. Composition des Véhicules</h4>
        <div id="patracdvr_container"></div>

        <h4>3. Personnel non attribué</h4>
        <button type="button" class="add-btn" id="addManualMemberBtn" style="margin-bottom: 10px;">➕ Créer Membre</button>
        <div id="unassigned_members_container"></div>

        <!-- TRASH -->
        <div id="trashCan">
            <span class="material-symbols-outlined">auto_delete</span>
            Glisser ici pour supprimer
        </div>

        <!-- GENERATE BUTTON -->
        <button id="generatePdfBtn" type="button">
            <span class="material-symbols-outlined" style="vertical-align: middle; margin-right:10px;">picture_as_pdf</span>
            Générer la Fiche PATRACDVR
        </button>

        <!-- CONFIGURATION UNITÉ (MERGED) -->
        <div class="collapsible">
            <div class="collapsible-header"><h4>Configuration Unité</h4><span class="toggle-arrow"><span class="material-symbols-outlined">expand_more</span></span></div>
            <div class="collapsible-content">
                <div class="form-group"><label for="oiFonctions">Fonctions</label><textarea id="oiFonctions" placeholder="Chef inter, Chef dispo, DE, Sans"></textarea><p class="help-text">Séparez chaque valeur par une virgule.</p></div>
                <div class="form-group"><label for="oiCellules">Cellules</label><textarea id="oiCellules" placeholder="AO1, AO2, India 1, India 2"></textarea></div>
                
                <div class="form-group"><label for="oiPrincipales">Armes Principales</label><textarea id="oiPrincipales" placeholder="UMP9, G36, FAP, Sans"></textarea></div>
                <div class="form-group"><label for="oiSecondaires">Armes Secondaires</label><textarea id="oiSecondaires" placeholder="PSA, Glock, Sans"></textarea></div>
                <div class="form-group"><label for="oiAfis">A.F.I. (Armes à Feux Intermédiaires)</label><textarea id="oiAfis" placeholder="PIE, LBD40, LBD44, Sans"></textarea></div>
                <div class="form-group"><label for="oiGrenades">Grenades</label><textarea id="oiGrenades" placeholder="GENL, MP7, Sans"></textarea></div>
                
                <div class="form-group"><label for="oiEquipements">Équipements 1</label><textarea id="oiEquipements" placeholder="Sans, BBAL, GENL, EFFRAC"></textarea></div>
                <div class="form-group"><label for="oiEquipements2">Équipements 2</label><textarea id="oiEquipements2" placeholder="Sans, Échelle, Stop stick"></textarea></div>
                <div class="form-group"><label for="oiTenues">Tenues</label><textarea id="oiTenues" placeholder="UBAS, 4S, Bleu, Treillis"></textarea></div>
                <div class="form-group"><label for="oiGpbs">GPB</label><textarea id="oiGpbs" placeholder="GPBL, GPBPD"></textarea></div>
            </div>
        </div>

        <footer>
             Module PATRACDVR Autonome
        </footer>
    </div>

    <!-- MODALE CRÉATION MEMBRE -->
    <dialog id="newMemberModal">
        <h3>Nouveau Membre</h3>
        <form id="newMemberForm" method="dialog" class="modal-form">
            <div class="full-width">
                <label for="new_trigramme">Trigramme</label>
                <input type="text" id="new_trigramme" placeholder="Ex: T1, CDG..." required autofocus>
            </div>
            
            <!-- Les selects seront générés dynamiquement par JS -->
            <div id="modal_dynamic_fields" style="display: contents;"></div>
            
        </form>
        <div class="modal-actions">
            <button type="button" class="remove-btn" id="cancelNewMemberBtn" style="color: var(--text-secondary); font-size: 1em;">Annuler</button>
            <button type="button" class="add-btn" id="confirmNewMemberBtn" style="background-color: var(--success-green); border-color: var(--success-green);">Ajouter</button>
        </div>
    </dialog>

    <!-- LIBRAIRIE PDF -->
    <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>

    <script>
        // --- CONFIGURATION DE BASE (CANEVAS DU JSON) ---
        // Constante pour la clé LocalStorage
        const LOCAL_STORAGE_KEY = 'oiFormDataLite';

        // Données extraites de members_config (1).json
        const DEFAULT_MEMBER_CONFIG = {
           fonctions: ["Chef inter", "Chef dispo", "Chef Oscar", "Conducteur", "Chef de bord", "DE", "Cyno", "Inter", "Effrac", "AO", "Sans"],
            cellules: ["AO1", "AO2", "AO3", "AO4", "AO5", "AO6", "AO7", "AO8", "India 1", "India 2", "India 3", "India 4", "India 5", "Effrac", "Sans"],
            principales: ["UMP9", "G36", "FAP", "Sans"],
            afis: ["PIE", "LBD40", "LBD44", "Sans"],
            secondaires: ["SP2022", "Glock 26", "Sans"],
            grenades: ["GENL", "MP7", "Sans"],
            equipements: ["Sans", "Casque Lourd", "Casque MO", "BBAL","Bouclier MO", "Belier", "Lacry", "IL", "Lot 5.11","HDR 50", "OP71","DoorRaider","Cintreuse"],
            equipements2: ["Sans", "Cam pieton", "Échelle", "Stop stick", "Lacry", "Cale", "IL", "Pass"],
            tenues: ["UBAS", "4S", "Bleu", "Civile", "Ghillie", "Treillis"],
            gpbs: ["GPBL", "GPBPD", "Sans"]
        };

        // Données membres par défaut vides
        const DEFAULT_MEMBERS = [];

        // Configuration active (copie modifiable des défauts)
        let memberConfig = JSON.parse(JSON.stringify(DEFAULT_MEMBER_CONFIG));

        const availableVehicles = ['Sharan', 'Kodiaq', 'Kodiaq Bana', '5008', 'Scénic', 'Expert', 'Traffic'];
        
        // MAPPING pour l'interface (Modal & QuickEdit)
        // Adapté pour correspondre exactement aux clés du JSON
        const attributeMapping = {
            'Fonction': { key: 'fonctions', attribute: 'fonction' },
            'Cellule': { key: 'cellules', attribute: 'cellule' },
            'Arme P.': { key: 'principales', attribute: 'principales' },
            'Arme S.': { key: 'secondaires', attribute: 'secondaires' },
            'A.F.I.': { key: 'afis', attribute: 'afis' },
            'Grenades': { key: 'grenades', attribute: 'grenades' },
            'Équip. 1': { key: 'equipements', attribute: 'equipement' },
            'Équip. 2': { key: 'equipements2', attribute: 'equipement2' },
            'Tenue': { key: 'tenues', attribute: 'tenue' },
            'GPB': { key: 'gpbs', attribute: 'gpb' }
        };

        const multiSelectAttributes = ['fonction', 'equipement', 'equipement2', 'afis'];

        // --- STATE ---
        let activeMemberId = null;
        let draggedItem = null;
        const patracdvrContainer = document.getElementById('patracdvr_container');
        const unassignedContainer = document.getElementById('unassigned_members_container');
        const quickEditPanel = document.getElementById('quickEditPanel');
        const newMemberModal = document.getElementById('newMemberModal');

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            setupQuickEditPanelUI();
            setupVehicleButtons();
            setupCollapsibles(); // Init collapsibles
            loadData();
            
            // Event Listeners globaux
            document.getElementById('addManualVehicleBtn').addEventListener('click', addManualVehicle);
            
            // MODIFICATION 2: Bouton "Créer membre" ouvre la modale
            document.getElementById('addManualMemberBtn').addEventListener('click', openNewMemberModal);
            document.getElementById('cancelNewMemberBtn').addEventListener('click', () => newMemberModal.close());
            document.getElementById('confirmNewMemberBtn').addEventListener('click', addNewMemberFromModal);

            document.getElementById('resetBtn').addEventListener('click', resetAll);
            document.getElementById('exportSessionBtn').addEventListener('click', exportData);
            document.getElementById('importSessionBtn').addEventListener('click', () => document.getElementById('importFileInput').click());
            document.getElementById('importFileInput').addEventListener('change', importData);

            document.getElementById('closeQuickEdit').addEventListener('click', () => {
                quickEditPanel.style.display = 'none';
                if(activeMemberId) {
                    const btn = document.getElementById(activeMemberId);
                    if(btn) btn.classList.remove('member-active');
                    activeMemberId = null;
                }
            });
            document.getElementById('generatePdfBtn').addEventListener('click', generatePatracdvrPdf);
            
            // Listeners pour sauvegarde auto des inputs mission
            document.getElementById('missionTitleInput').addEventListener('input', saveData);
            document.getElementById('rallyTimeInput').addEventListener('input', saveData);

            // Drag and Drop global listeners
            document.addEventListener('dragstart', handleDragStart);
            document.addEventListener('dragend', handleDragEnd);
            
            document.addEventListener('dragover', handleDragOver);
            document.addEventListener('drop', handleDrop);
            document.addEventListener('dragenter', handleDragEnter);
            document.addEventListener('dragleave', handleDragLeave);

            // Input trigramme listener
            document.getElementById('quick_edit_trigramme_input').addEventListener('input', (e) => {
                if(activeMemberId) {
                    const member = document.getElementById(activeMemberId);
                    member.dataset.trigramme = e.target.value.toUpperCase();
                    updateMemberButtonVisuals(member);
                    saveData();
                }
            });

            // Listeners pour la configuration
            document.querySelectorAll('.collapsible-content textarea').forEach(textarea => {
                textarea.addEventListener('change', updateMemberConfigFromForm);
            });
        });

        // --- CORE FUNCTIONS ---

        function setupVehicleButtons() {
            const container = document.getElementById('vehicle_creation_buttons');
            availableVehicles.forEach(v => {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'add-btn';
                btn.textContent = `➕ ${v}`;
                btn.onclick = () => { addPatracdvrRow(v); saveData(); };
                container.insertBefore(btn, document.getElementById('addManualVehicleBtn')); // Insert before manual btn
            });
        }

        function addManualVehicle() {
            const name = prompt("Nom du véhicule :");
            if (name) { addPatracdvrRow(name); saveData(); }
        }

        function addPatracdvrRow(vehicleName, members = []) {
            // Check doublon
            if (document.querySelector(`.patracdvr-vehicle-row[data-vehicle-name="${vehicleName}"]`)) {
                // Si le véhicule existe déjà, on ne fait rien (utile lors du restore)
                return;
            }

            const row = document.createElement('div');
            row.className = 'patracdvr-vehicle-row';
            row.dataset.vehicleName = vehicleName;
            row.innerHTML = `
                <div class="vehicle-header">
                    <span class="vehicle-name">${vehicleName}</span>
                    <button type="button" class="remove-btn" title="Supprimer Véhicule">❌</button>
                </div>
                <div class="patracdvr-members-container drop-zone"></div>
            `;

            // Delete handler
            row.querySelector('.remove-btn').onclick = () => {
                if(confirm(`Supprimer ${vehicleName} et désattribuer les membres ?`)) {
                    const membersContainer = row.querySelector('.patracdvr-members-container');
                    Array.from(membersContainer.children).forEach(btn => {
                        btn.dataset.cellule = 'Sans';
                        updateMemberButtonVisuals(btn);
                        unassignedContainer.appendChild(btn);
                    });
                    row.remove();
                    saveData();
                }
            };

            patracdvrContainer.appendChild(row);
            const membersContainer = row.querySelector('.patracdvr-members-container');
            if (members && members.length > 0) {
                members.forEach(m => addPatracdvrMember(membersContainer, m));
            }
        }

        function addPatracdvrMember(container, data = {}) {
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'patracdvr-member-btn draggable';
            btn.id = `mem_${Date.now()}_${Math.random().toString(36).substr(2,5)}`;
            btn.draggable = true;
            
            const defaults = {
                trigramme: 'N/A', fonction: 'Sans', cellule: 'Sans', principales: 'Sans', secondaires: 'PSA',
                afis: 'Sans', grenades: 'Sans', equipement: 'Sans', equipement2: 'Sans', tenue: 'UBAS', gpb: 'GPBL'
            };
            
            // Merge defaults and data
            // Note: on ignore les clés comme 'vehicle_assigned' pour l'affichage, elles ne servent qu'à la restoration
            const memberData = { ...defaults, ...data };
            
            // Stocker les données dans le dataset du bouton
            Object.keys(memberData).forEach(k => {
                if (k !== 'vehicle_assigned') {
                     btn.dataset[k] = memberData[k];
                }
            });

            updateMemberButtonVisuals(btn);
            btn.onclick = (e) => handleMemberSelection(e, btn);
            container.appendChild(btn);
            return btn;
        }

        function updateMemberButtonVisuals(btn) {
            const trig = btn.dataset.trigramme;
            const func = btn.dataset.fonction !== 'Sans' ? btn.dataset.fonction : '';
            const cell = btn.dataset.cellule !== 'Sans' ? btn.dataset.cellule : '';
            
            let subText = '';
            if (cell && func) subText = `${cell} / ${func}`;
            else if (cell) subText = cell;
            else if (func) subText = func;

            btn.innerHTML = `<span class="trigramme">${trig}</span>`;
            if (subText && !btn.closest('#unassigned_members_container')) {
                btn.innerHTML += `<span class="fonction">${subText}</span>`;
            }
        }

        // --- MODAL LOGIC (MODIFICATION 2) ---

        function openNewMemberModal() {
            // Reset input
            document.getElementById('new_trigramme').value = '';
            
            // Génération dynamique des champs select
            const container = document.getElementById('modal_dynamic_fields');
            container.innerHTML = '';
            
            for (const [label, conf] of Object.entries(attributeMapping)) {
                const wrapper = document.createElement('div');
                const selectId = `new_mem_${conf.attribute}`;
                
                let optionsHtml = '';
                const options = memberConfig[conf.key] || [];
                options.forEach(opt => {
                    // Par défaut, sélectionner 'Sans' ou le premier élément
                    const isSelected = opt === 'Sans' ? 'selected' : '';
                    optionsHtml += `<option value="${opt}" ${isSelected}>${opt}</option>`;
                });

                wrapper.innerHTML = `
                    <label for="${selectId}">${label}</label>
                    <select id="${selectId}">${optionsHtml}</select>
                `;
                container.appendChild(wrapper);
            }

            newMemberModal.showModal();
        }

        function addNewMemberFromModal() {
            const trigramme = document.getElementById('new_trigramme').value.trim().toUpperCase();
            if (!trigramme) {
                alert("Le trigramme est obligatoire.");
                return;
            }

            const newData = { trigramme: trigramme };
            
            // Récupérer les valeurs des selects
            for (const [label, conf] of Object.entries(attributeMapping)) {
                const selectId = `new_mem_${conf.attribute}`;
                const val = document.getElementById(selectId).value;
                newData[conf.attribute] = val;
            }

            // Logique d'auto-assignation (optionnelle, pour cohérence)
            if (newData.cellule === 'Sans') newData.fonction = 'Sans';
            if (newData.fonction !== 'Sans' && newData.cellule === 'Sans') newData.cellule = 'India 1';

            addPatracdvrMember(unassignedContainer, newData);
            saveData();
            newMemberModal.close();
        }


        // --- QUICK EDIT PANEL ---

        function setupQuickEditPanelUI(targetMember = null) {
            const content = quickEditPanel.querySelector('.quick-edit-content');
            content.innerHTML = '';

            for (const [label, conf] of Object.entries(attributeMapping)) {
                const catDiv = document.createElement('div');
                catDiv.className = 'quick-edit-category';
                catDiv.innerHTML = `<h5>${label}</h5>`;
                const optsDiv = document.createElement('div');
                optsDiv.className = 'quick-edit-options';

                // 1. Get Base Options
                let options = [...(memberConfig[conf.key] || [])];

                // 2. Merge with Member's Custom Values if present
                if (targetMember) {
                    const memberVal = targetMember.dataset[conf.attribute];
                    if (memberVal && memberVal !== 'Sans') {
                        const values = multiSelectAttributes.includes(conf.attribute) 
                                       ? memberVal.split(', ') 
                                       : [memberVal];
                        
                        values.forEach(v => {
                             if (v !== 'Sans' && !options.includes(v)) {
                                 options.push(v);
                             }
                        });
                    }
                }

                options.forEach(opt => {
                    const b = document.createElement('button');
                    b.className = 'quick-edit-btn';
                    b.type = 'button';
                    b.textContent = opt;
                    b.dataset.attribute = conf.attribute;
                    b.dataset.value = opt;
                    b.onclick = (e) => handleQuickEditClick(e, b);
                    optsDiv.appendChild(b);
                });
                catDiv.appendChild(optsDiv);
                content.appendChild(catDiv);
            }
        }

        function handleMemberSelection(e, btn) {
            e.stopPropagation();
            // Toggle selection
            if (activeMemberId === btn.id) {
                btn.classList.remove('member-active');
                activeMemberId = null;
                quickEditPanel.style.display = 'none';
                return;
            }

            // Deselect old
            if (activeMemberId) {
                const old = document.getElementById(activeMemberId);
                if (old) old.classList.remove('member-active');
            }

            activeMemberId = btn.id;
            btn.classList.add('member-active');
            
            // Populate panel
            document.getElementById('selectedMemberTrigramme').textContent = btn.dataset.trigramme;
            document.getElementById('quick_edit_trigramme_input').value = btn.dataset.trigramme;
            
            // Generate Buttons with potential custom values from this member
            setupQuickEditPanelUI(btn);
            
            refreshQuickEditButtons(btn);
            
            quickEditPanel.style.display = 'flex';
            // Scroll to panel on mobile
            if(window.innerWidth < 768) quickEditPanel.scrollIntoView({behavior: "smooth"});
        }

        function refreshQuickEditButtons(btn) {
            document.querySelectorAll('.quick-edit-btn').forEach(qBtn => {
                const attr = qBtn.dataset.attribute;
                const val = qBtn.dataset.value;
                const memberVal = btn.dataset[attr];
                
                if (multiSelectAttributes.includes(attr)) {
                    const current = memberVal ? memberVal.split(', ') : [];
                    qBtn.classList.toggle('selected', current.includes(val));
                } else {
                    qBtn.classList.toggle('selected', memberVal === val);
                }
            });
        }

        function handleQuickEditClick(e, qBtn) {
            if (!activeMemberId) return;
            const btn = document.getElementById(activeMemberId);
            const attr = qBtn.dataset.attribute;
            const val = qBtn.dataset.value;

            if (multiSelectAttributes.includes(attr)) {
                let current = btn.dataset[attr] && btn.dataset[attr] !== 'Sans' ? btn.dataset[attr].split(', ') : [];
                
                if (val === 'Sans') {
                    current = ['Sans'];
                } else {
                    if (current.includes('Sans')) current = [];
                    if (current.includes(val)) current = current.filter(x => x !== val);
                    else current.push(val);
                }
                if (current.length === 0) current = ['Sans'];
                btn.dataset[attr] = current.join(', ');
            } else {
                // Single select logic with auto-assignment
                btn.dataset[attr] = val;
                
                // Auto-Assign Logic
                if (attr === 'cellule' && val === 'Sans') btn.dataset.fonction = 'Sans';
                if (attr === 'fonction' && val !== 'Sans' && btn.dataset.cellule === 'Sans') btn.dataset.cellule = 'India 1';
            }

            updateMemberButtonVisuals(btn);
            refreshQuickEditButtons(btn);
            saveData();
        }

        // --- DRAG AND DROP ---
        
        function handleDragStart(e) {
            if (e.target.classList.contains('draggable')) {
                draggedItem = e.target;
                e.target.classList.add('dragging');
                e.dataTransfer.effectAllowed = 'move';
            }
        }

        function handleDragEnd(e) {
            if (draggedItem) {
                draggedItem.classList.remove('dragging');
                draggedItem = null;
            }
            document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
            document.getElementById('trashCan').classList.remove('drag-over');
            document.querySelectorAll('#patracdvr_container, #unassigned_members_container, .patracdvr-members-container').forEach(el => el.style.borderStyle = 'dashed');
        }

        function handleDragEnter(e) {
            e.preventDefault();
            const target = e.target.closest('#trashCan, .patracdvr-members-container, #unassigned_members_container');
            if (target && draggedItem) {
                if (target.id === 'trashCan') {
                    target.classList.add('drag-over');
                } else {
                    target.style.borderStyle = 'solid';
                    target.style.borderColor = 'var(--accent-blue)';
                }
            }
        }

        function handleDragOver(e) {
            e.preventDefault();
            const target = e.target.closest('#trashCan, .patracdvr-members-container, #unassigned_members_container');
            if (!target) return;
            
            if (target.id === 'trashCan') {
                target.classList.add('drag-over');
            } else {
                target.style.borderStyle = 'solid';
                target.style.borderColor = 'var(--accent-blue)';
                
                const afterElement = getDragAfterElement(target, e.clientY);
                if (draggedItem) {
                    if (afterElement == null) {
                        target.appendChild(draggedItem);
                    } else {
                        target.insertBefore(draggedItem, afterElement);
                    }
                }
            }
        }

        function handleDragLeave(e) {
            const target = e.target.closest('#trashCan, .patracdvr-members-container, #unassigned_members_container');
            if (target) {
                if (e.relatedTarget && target.contains(e.relatedTarget)) { return; }
                target.classList.remove('drag-over');
                target.style.borderStyle = 'dashed';
                target.style.borderColor = 'var(--border-glass)';
            }
        }

        function handleDrop(e) {
            e.preventDefault();
            const trash = e.target.closest('#trashCan');
            
            if (trash && draggedItem) {
                // Modification: Suppression définitive directe sans confirmation
                if (activeMemberId === draggedItem.id) {
                    quickEditPanel.style.display = 'none';
                    activeMemberId = null;
                }
                draggedItem.remove();
                saveData();
                return;
            }

            const targetContainer = e.target.closest('.patracdvr-members-container, #unassigned_members_container');
            if (targetContainer && draggedItem) {
                if (targetContainer.id === 'unassigned_members_container') {
                    draggedItem.dataset.cellule = 'Sans';
                    draggedItem.dataset.fonction = 'Sans';
                } else {
                    if (draggedItem.dataset.cellule === 'Sans') draggedItem.dataset.cellule = 'India 1';
                }
                updateMemberButtonVisuals(draggedItem);
                saveData();
            }
        }

        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.draggable:not(.dragging)')];
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        // --- DATA & PERSISTENCE ---

        function getMemberData(btn) {
            const d = btn.dataset;
            return {
                trigramme: d.trigramme, fonction: d.fonction, cellule: d.cellule,
                principales: d.principales, secondaires: d.secondaires, afis: d.afis,
                grenades: d.grenades, equipement: d.equipement, equipement2: d.equipement2,
                tenue: d.tenue, gpb: d.gpb
            };
        }

        /**
         * SAVE DATA - Modifié pour respecter le canevas members_config.json
         * Structure: { options: {...}, members: [ {..., vehicle_assigned: "vName" } ], mission_info: {...} }
         */
        function saveData() {
            const allMembers = [];

            // 1. Récupérer les non-assignés (vehicle_assigned = null/undefined)
            unassignedContainer.querySelectorAll('.patracdvr-member-btn').forEach(btn => {
                const m = getMemberData(btn);
                m.vehicle_assigned = null; // Marqueur interne
                allMembers.push(m);
            });

            // 2. Récupérer les assignés (dans les véhicules)
            document.querySelectorAll('.patracdvr-vehicle-row').forEach(row => {
                const vName = row.dataset.vehicleName;
                row.querySelectorAll('.patracdvr-member-btn').forEach(btn => {
                    const m = getMemberData(btn);
                    m.vehicle_assigned = vName; // Marqueur interne
                    allMembers.push(m);
                });
            });

            const data = {
                options: memberConfig,
                members: allMembers,
                mission_info: {
                    title: document.getElementById('missionTitleInput').value,
                    rally: document.getElementById('rallyTimeInput').value
                }
            };

            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(data));
            return data;
        }

        function loadData() {
            const json = localStorage.getItem(LOCAL_STORAGE_KEY);
            if (!json) {
                populateConfigForm();
                return;
            }
            try {
                const data = JSON.parse(json);
                restoreDataFromObject(data);
            } catch (e) { console.error("Load error", e); }
        }

        /**
         * RESTORE DATA - Modifié pour lire le format plat avec vehicle_assigned
         */
        function restoreDataFromObject(data) {
            // Nettoyage
            patracdvrContainer.innerHTML = '';
            unassignedContainer.innerHTML = '';

            // 1. Restauration Configuration Options (si présente)
            if (data.options) {
                // Fusion intelligente : Constantes par défaut + Valeurs importées uniques
                Object.keys(DEFAULT_MEMBER_CONFIG).forEach(key => {
                    const defaultValues = DEFAULT_MEMBER_CONFIG[key];
                    const importedValues = data.options[key] || [];
                    
                    if (Array.isArray(defaultValues)) {
                        // Merge arrays et suppression des doublons
                        const combined = [...defaultValues, ...importedValues];
                        memberConfig[key] = [...new Set(combined)];
                    } else {
                        memberConfig[key] = importedValues;
                    }
                });

                // Ajouter les clés qui existent dans l'import mais pas dans les défauts
                Object.keys(data.options).forEach(key => {
                    if (!DEFAULT_MEMBER_CONFIG.hasOwnProperty(key)) {
                        memberConfig[key] = data.options[key];
                    }
                });

                setupQuickEditPanelUI();
                populateConfigForm(); // Update form with loaded options
            }

            // 2. Restauration Mission Info
            // Supporte l'ancien format (root) et le nouveau format (mission_info)
            const mTitle = data.mission_info ? data.mission_info.title : (data.missionTitle || '');
            const mRally = data.mission_info ? data.mission_info.rally : (data.rallyTime || '');
            document.getElementById('missionTitleInput').value = mTitle;
            document.getElementById('rallyTimeInput').value = mRally;

            // 3. Restauration Membres & Véhicules
            // Cas A : Nouveau format (members list with vehicle_assigned)
            if (data.members && Array.isArray(data.members)) {
                
                // Identifier les véhicules à créer
                const vehiclesToCreate = [...new Set(data.members
                    .filter(m => m.vehicle_assigned)
                    .map(m => m.vehicle_assigned))];

                // Créer les lignes de véhicules
                vehiclesToCreate.forEach(vName => addPatracdvrRow(vName));

                // Distribuer les membres
                data.members.forEach(m => {
                    if (m.vehicle_assigned) {
                        const row = document.querySelector(`.patracdvr-vehicle-row[data-vehicle-name="${m.vehicle_assigned}"]`);
                        if (row) {
                            addPatracdvrMember(row.querySelector('.patracdvr-members-container'), m);
                        } else {
                            addPatracdvrMember(unassignedContainer, m); // Fallback
                        }
                    } else {
                        addPatracdvrMember(unassignedContainer, m);
                    }
                });
            } 
            // Cas B : Ancien format de sauvegarde (rows array + unassigned array) - Rétrocompatibilité
            else if (data.rows || data.unassigned) {
                if (data.rows) data.rows.forEach(r => addPatracdvrRow(r.vehicle, r.members));
                if (data.unassigned) data.unassigned.forEach(m => addPatracdvrMember(unassignedContainer, m));
            }
            
            // Si aucune option chargée (premier lancement), on peuple le formulaire avec les défauts
            if (!data.options) populateConfigForm();
        }

        function resetAll() {
            if (confirm("Tout effacer ? Cela rechargera la configuration par défaut.")) {
                localStorage.removeItem(LOCAL_STORAGE_KEY);
                location.reload();
            }
        }

        function exportData() {
            const data = saveData();
            const jsonStr = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonStr], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            // Format demandé : PATRACDVR-DATE
            const dateStr = new Date().toISOString().slice(0,10);
            a.download = `PATRACDVR-${dateStr}.json`;
            a.click();
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if(confirm("Importer ce fichier va écraser la session actuelle. Continuer ?")) {
                        restoreDataFromObject(data);
                        saveData(); // Persist le nouvel état
                        alert("Importation réussie !");
                    }
                } catch(err) {
                    alert("Erreur lors de l'importation : " + err.message);
                }
                // Reset input pour permettre de réimporter le même fichier
                event.target.value = '';
            };
            reader.readAsText(file);
        }

        // --- CONFIGURATION FUNCTIONS (MERGED) ---

        function setupCollapsibles() {
            document.querySelectorAll('.collapsible-header').forEach(header => {
                header.addEventListener('click', () => {
                    const parent = header.parentElement;
                    parent.classList.toggle('open');
                });
            });
        }

        function populateConfigForm() {
            const getArrayFromTextarea = (key) => (memberConfig[key] || []).join(', ');
            
            document.getElementById('oiFonctions').value = getArrayFromTextarea('fonctions');
            document.getElementById('oiCellules').value = getArrayFromTextarea('cellules');
            document.getElementById('oiPrincipales').value = getArrayFromTextarea('principales');
            document.getElementById('oiSecondaires').value = getArrayFromTextarea('secondaires');
            document.getElementById('oiAfis').value = getArrayFromTextarea('afis');
            document.getElementById('oiGrenades').value = getArrayFromTextarea('grenades');
            document.getElementById('oiEquipements').value = getArrayFromTextarea('equipements');
            document.getElementById('oiEquipements2').value = getArrayFromTextarea('equipements2');
            document.getElementById('oiTenues').value = getArrayFromTextarea('tenues');
            document.getElementById('oiGpbs').value = getArrayFromTextarea('gpbs');
        }

        function updateMemberConfigFromForm() {
            const getArrayFromTextarea = (id) => {
                const items = document.getElementById(id).value.split(',').map(item => item.trim()).filter(Boolean);
                return [...new Set(items)];
            };
            memberConfig.fonctions = getArrayFromTextarea('oiFonctions');
            memberConfig.cellules = getArrayFromTextarea('oiCellules');
            memberConfig.principales = getArrayFromTextarea('oiPrincipales');
            memberConfig.secondaires = getArrayFromTextarea('oiSecondaires');
            memberConfig.afis = getArrayFromTextarea('oiAfis');
            memberConfig.grenades = getArrayFromTextarea('oiGrenades');
            memberConfig.equipements = getArrayFromTextarea('oiEquipements');
            memberConfig.equipements2 = getArrayFromTextarea('oiEquipements2');
            memberConfig.tenues = getArrayFromTextarea('oiTenues');
            memberConfig.gpbs = getArrayFromTextarea('oiGpbs');
            setupQuickEditPanelUI();
            saveData();
        }

        // --- PDF GENERATION ---
        
        async function generatePatracdvrPdf() {
            const { PDFDocument, StandardFonts, rgb, PageSizes } = PDFLib;
            const pdfDoc = await PDFDocument.create();
            const helveticaFont = await pdfDoc.embedFont(StandardFonts.Helvetica);
            const helveticaBold = await pdfDoc.embedFont(StandardFonts.HelveticaBold);

            // Helpers PDF
            let page = pdfDoc.addPage([PageSizes.A4[1], PageSizes.A4[0]]); // Landscape
            let { width, height } = page.getSize();
            let y = height - 40;
            const margin = 40;

            const drawText = (text, size, font, x, y, color = rgb(0,0,0)) => {
                page.drawText(String(text), { x, y, size, font, color });
            };

            const addNewPageIfNeeded = (neededHeight) => {
                if (y - neededHeight < margin) {
                    page = pdfDoc.addPage([PageSizes.A4[1], PageSizes.A4[0]]);
                    y = height - 40;
                    return true;
                }
                return false;
            };

            // Fonction pour découper le texte sur plusieurs lignes (Word Wrapping)
            const wrapText = (text, font, size, maxWidth) => {
                const words = String(text || '').replace(/\n/g, ' \n ').split(' ');
                let lines = [];
                let currentLine = '';
                for (const word of words) {
                    if (word === '\n') {
                        lines.push(currentLine);
                        currentLine = '';
                        continue;
                    }
                    const lineWithWord = currentLine === '' ? word : `${currentLine} ${word}`;
                    const width = font.widthOfTextAtSize(lineWithWord, size);
                    if (width > maxWidth && currentLine !== '') {
                        lines.push(currentLine);
                        currentLine = word;
                    } else {
                        currentLine = lineWithWord;
                    }
                }
                lines.push(currentLine);
                return lines;
            };

            // Title Logic
            const missionTitle = document.getElementById('missionTitleInput').value.trim();
            const mainTitle = missionTitle ? `PATRACDVR - Mission : ${missionTitle}` : "FICHE PATRACDVR";

            drawText(mainTitle, 24, helveticaBold, margin, y, rgb(0, 51/255, 160/255));
            y -= 40;

            // Headers - Structure identique au JSON (Arme P, Arme S, AFI, Grenades)
            const headers = ["PAX", "Fct", "Cel.", "Arme P.", "Arme S.", "AFI", "Gren.", "Equip 1", "Equip 2", "Tenue", "GPB"];
            const colWidths = [50, 70, 60, 70, 50, 60, 60, 80, 80, 60, 60];
            const startX = margin;
            
            // Collect Data
            const rowsData = [];
            document.querySelectorAll('.patracdvr-vehicle-row').forEach(row => {
                const vName = row.dataset.vehicleName;
                rowsData.push({ type: 'header', text: `VÉHICULE : ${vName}` });
                
                row.querySelectorAll('.patracdvr-member-btn').forEach(btn => {
                    const d = btn.dataset;
                    rowsData.push({
                        type: 'data',
                        cells: [d.trigramme, d.fonction, d.cellule, d.principales, d.secondaires, d.afis, d.grenades, d.equipement, d.equipement2, d.tenue, d.gpb]
                    });
                });
                // Spacer
                rowsData.push({ type: 'spacer' });
            });

            // Draw Table
            const contentFontSize = 10;
            const cellPadding = 4;

            // Draw Column Headers initial
            const drawColumnHeaders = () => {
                let currentX = startX;
                headers.forEach((h, i) => {
                    page.drawRectangle({ x: currentX, y: y - 20, width: colWidths[i], height: 20, color: rgb(0.9, 0.9, 0.9), borderColor: rgb(0,0,0), borderWidth: 1 });
                    drawText(h, 9, helveticaBold, currentX + 2, y - 14);
                    currentX += colWidths[i];
                });
                y -= 20;
            };

            drawColumnHeaders();

            for (const row of rowsData) {
                if (row.type === 'header') {
                    // Vehicle Header Row
                    if (addNewPageIfNeeded(45)) { // 25 for header + 20 for cols
                        drawColumnHeaders();
                    }
                    page.drawRectangle({ x: startX, y: y - 20, width: width - 2*margin, height: 20, color: rgb(0.85, 0.93, 1) });
                    drawText(row.text, 12, helveticaBold, startX + 5, y - 15, rgb(0, 0.2, 0.6));
                    y -= 25;
                } else if (row.type === 'data') {
                    // Data Row avec hauteur dynamique
                    // 1. Calculer les lignes pour chaque cellule
                    const cellLines = row.cells.map((cellText, i) => {
                        let text = (cellText === 'Sans' || !cellText) ? '-' : cellText;
                        return wrapText(text, helveticaFont, contentFontSize, colWidths[i] - (cellPadding * 2));
                    });

                    // 2. Déterminer la hauteur maximale de la ligne
                    const maxLines = Math.max(...cellLines.map(l => l.length), 1);
                    const lineHeight = contentFontSize + 2;
                    const rowHeight = (maxLines * lineHeight) + (cellPadding * 2);

                    if (addNewPageIfNeeded(rowHeight)) {
                        drawColumnHeaders();
                    }

                    // 3. Dessiner la ligne
                    let currentX = startX;
                    row.cells.forEach((_, i) => {
                        // Rectangle de fond de cellule
                        page.drawRectangle({ x: currentX, y: y - rowHeight, width: colWidths[i], height: rowHeight, borderColor: rgb(0.8,0.8,0.8), borderWidth: 0.5 });
                        
                        // Texte ligne par ligne
                        const lines = cellLines[i];
                        lines.forEach((line, lineIdx) => {
                            page.drawText(line, {
                                x: currentX + cellPadding,
                                y: y - cellPadding - (lineIdx * lineHeight) - contentFontSize + 3,
                                size: contentFontSize,
                                font: helveticaFont,
                                color: rgb(0,0,0)
                            });
                        });
                        
                        currentX += colWidths[i];
                    });
                    y -= rowHeight;

                } else if (row.type === 'spacer') {
                    y -= 10;
                }
            }

            // --- RALLY TIME FOOTER ---
            const rallyTime = document.getElementById('rallyTimeInput').value.trim();
            if (rallyTime) {
                const footerText = `Heure de rassemblement : ${rallyTime}`;
                // Ensure space
                if (y < margin + 30) {
                     page = pdfDoc.addPage([PageSizes.A4[1], PageSizes.A4[0]]);
                     y = height - 40;
                } else {
                    y -= 20; // Space from table
                }
                
                page.drawText(footerText, {
                    x: margin,
                    y: y,
                    size: 14,
                    font: helveticaBold,
                    color: rgb(0,0,0)
                });
            }

            // Save
            const pdfBytes = await pdfDoc.save();
            const blob = new Blob([pdfBytes], { type: 'application/pdf' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            const safeTitle = missionTitle ? missionTitle.replace(/[^a-z0-9]/gi, '_').toLowerCase() : 'patracdvr';
            link.download = `PATRACDVR_${safeTitle}_${new Date().toISOString().slice(0,10)}.pdf`;
            link.click();
        }

    </script>
</body>
</html>
